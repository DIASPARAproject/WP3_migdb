---
title: "The metric and stock DB with example of their format and use for WNAS, WGEEL and WGBAST"
author: "Cédric Briand, Jules Oliviéro, Jani Helminen"
fontsize: 20pt
filters:
  - quarto-kroki
title-slide-attributes:
  data-background-image: images/diaspara_background.png
  data-background-size: stretch
  data-background-opacity: "0.5"
logo: images/diaspara_participants_logo_withEUlogo.png
footer: ""
engine: knitr
format: 
  revealjs :
    self-contained: true
theme: 
  - solarized
background-transition: fade
editor: visual
---


```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Vilaine/Projets/DIASPARA/wgbast"
}
source("utilities/load_library.R")
load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
load_library("RPostgres")
load_library("yaml")
load_library("DBI")
load_library("ggplot2")
load_library("sf")
load_library("janitor") #
load_library("htmltools") 
load_library("leaflet")
cred <- read_yaml("../credentials.yml")
# con_diaspara <- dbConnect(Postgres(), 
#                            dbname = cred$dbnamehydro,
#                            host = cred$hostmercure,
#                            port = cred$port,
#                            user = cred$usermercure,
#                            password = cred$passwordmercure)
con_diaspara <- dbConnect(Postgres(), 
                          dbname = cred$dbnamediaspara,
                          host = cred$hostdistant,
                          port = cred$port,
                          user = cred$userdiaspara,
                          password = cred$passworddiaspara)

```

# Refresh from the previous presentations



![](images/clipboard-154407505.png)

# Refresh from the previous presentations

![](images/clipboard-4195111625.png)

::: {.notes}
JANI : yesterday you presented the DB, how do that works in practise, can you tell us more about the structure of the DB. ?
:::

# The DIADROMOUS DATABASE

```{dot}
//| label: fig-schema_diaspara
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance, pink or red colors indicate work in progress, blue color refers to the stock database, green color to the metric database.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref"."Deprecated"  <br align="left"/>
"ref"."EDMO" <br align="left"/>
"ref"."MSTAT" <br align="left"/>
"ref"."PRGOV" <br align="left"/>
"ref"."PURPM" <br align="left"/>
"ref"."StationDictionary" <br align="left"/>
"ref"."Station_DTYPE" <br align="left"/>
"ref"."WLTYP" <br align="left"/>
"ref".riversegments <br align="left"/>
"ref".tr_age_age <br align="left"/>
"ref".tr_area_are <br align="left"/>
"ref".tr_category_cat <br align="left"/>
"ref".tr_country_cou <br align="left"/>
"ref".tr_dataaccess_dta <br align="left"/>
"ref".tr_databasis_dtb <br align="left"/>
"ref".tr_datasource_dts <br align="left"/>
"ref".tr_destination_des <br align="left"/>
"ref".tr_estimationmethod_esm <br align="left"/>
"ref".tr_fishingarea_fia <br align="left"/>
"ref".tr_fishway_fiw <br align="left"/>
<font color="pink">
"ref".tr_gear_gea <br align="left"/>
</font>
"ref".tr_habitat_hab <br align="left"/>
"ref".tr_habitatlevel_lev <br align="left"/>
"ref".tr_habitattype_hty <br align="left"/>
"ref".tr_icworkinggroup_wkg <br align="left"/>
"ref".tr_lifestage_lfs <br align="left"/>
"ref".tr_maturity_mat <br align="left"/>
"ref".tr_metric_mtr <br align="left"/>
"ref".tr_missvalueqal_mis <br align="left"/>
"ref".tr_monitoring_mon <br align="left"/>
"ref".tr_nimble_nim <br align="left"/>
<font color="pink">
"ref".tr_objecttype_oty <br align="left"/>
</font>
"ref".tr_outcome_oco <br align="left"/>
"ref".tr_quality_qal <br align="left"/>
"ref".tr_rivernames_riv <br align="left"/>
"ref".tr_sex_sex <br align="left"/>
"ref".tr_species_spe <br align="left"/>
"ref".tr_timeperiod_tip <br align="left"/>
<font color="lightgreen">
"ref".tr_trait_tra <br align="left"/>
"ref".tr_traitmethod_trm <br align="left"/>
"ref".tr_traitnumeric_trn <br align="left"/>
"ref".tr_traitqualitative_trq <br align="left"/>
"ref".tr_traitvaluequal_trv <br align="left"/>
"ref".tr_units_uni <br align="left"/>
"ref".tr_version_ver
</font>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
dat.t_stock_sto<br align="left"/>
dat.t_metadata_met<br align="left"/>
</font>
dat.t_series_ser <br align="left"/>
dat.t_serannual_san <br align="left"/>
dat.t_group_gr <br align="left"/>
dat.t_grouptrait_grt <br align="left"/>
dat.t_fish_fi <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
refeel.tg_trait_tra<br align="left"/>
refeel.tr_area_are<br align="left"/>
refeel.tr_traitmethod_trm<br align="left"/>
refeel.tr_traitnumeric_trn<br align="left"/>
refeel.tr_traitqualitative_trq<br align="left"/>
refeel.tr_traitvaluequal_trv<br align="left"/>
refeel.tr_version_ver
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<font color="blue">dateel.t_metadata_met</font> <br align="left"/>
<font color="blue">dateel.t_stock_sto</font> <br align="left"/>
dateel.t_series_ser <br align="left"/>
dateel.t_serannual_san <br align="left"/>
dateel.t_group_gr <br align="left"/>
dateel.t_grouptrait_grt <br align="left"/>
dateel.t_fish_fi <br align="left"/>
dateel.tj_seriesstation_ses <br align="left"/> </td> </tr>
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">refbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="white">
refbast.tr_area_are <br align="left"/> 
refbast.tr_estimationmethod_esm <br align="left"/> 
refbast.tr_rivernames_riv <br align="left"/> 
refbast.tr_version_ver <br align="left"/> 
</font>
<font color="pink">
refbast.tr_traitmethod_trm<br align="left"/>
refbast.tr_traitnumeric_trn<br align="left"/>
refbast.tr_traitqualitative_trq<br align="left"/>
refbast.tr_traitvaluequal_trv<br align="left"/>
</font>
</td> </tr> 
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">datbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
    datbast.t_stock_sto <br align="left"/>
    datbast.t_metadata_met <br align="left"/>
</font>
<font color="white">
    datbast.t_series_ser <br align="left"/>
    datbast.t_serannual_san <br align="left"/>
    datbast.t_group_gr <br align="left"/>
    datbast.t_grouptrait_grt <br align="left"/>
    datbast.t_fish_fi <br align="left"/>
</font> 
 </td> </tr>
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
refnas.tg_additional_add <br align="left"/>
</font>
refnas.tr_area_are <br align="left"/>
refnas.tr_rivernames_riv <br align="left"/>
refnas.tr_version_ver <br align="left"/>

</td> </tr> 
</table>> 
shape = cylinder];

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
datnas.t_stock_sto <br align="left"/>
datnas.t_metadata_met <br align="left"/>
</font>
<font color="red">
datnas.t_archive_ar <br align="left"/>
</font>

</td> </tr>
</table>> 
shape = cylinder];  

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```

::: notes
OK don't be afraid ... We'll go to the details... As an introduction, the objective of this presentation is to highlight some elements of the DB, demontrate that the structure adapts to the need of all working groups. It might sometimes be a bit technical, as it is also intended to convey some technical aspects to ICES data centre.
:::

# The DIADROMOUS DATABASE

```{dot}
//| label: fig-schema_diaspara_simplified
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refbast</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr>  
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datbast</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder]; 

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder]; 

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```
::: notes
So if we ignore the content of referential tables, we can layout the structure.
Remember from yesterday presentation, the DIADROMOUS database is made of two main components, the ***metric DB*** and the **stockDB**. Both structures make use of the same referential tables, while data are provided in specific shcema to each working group.

***The DB uses inheritance***.
An inherited table is a table containing all the columns from a mother table.
A query in the mother table with show the content of daughter tables.
In practise we have different shema with both referentials (dictionaries) and data.
All the tables are created in the child schema (here refnas, datanas ...). This ensures that the DB has the same structure. Additional columns exist in some of the daughter tables, e.g. the datnas.t_stock_sto has the same columns as dat. t_stock_sto
but it has some more.
Constraints foreign keys are created in the working group schemas, so they might differ from one shema to the rest
The structure of the DB will need to rely on views (instead of inheritance) when 
transposed to SQL server.
:::

# The DIADROMOUS DATABASE

```{dot}
//| label: fig-schema_diaspara_ref
//| fig-cap: Referential only split in three parts.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];

ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref".tr_lifestage_lfs <br align="left"/>
"ref".tr_maturity_mat <br align="left"/>
"ref".tr_metric_mtr <br align="left"/>
"ref".tr_missvalueqal_mis <br align="left"/>
"ref".tr_monitoring_mon <br align="left"/>
"ref".tr_nimble_nim <br align="left"/>
<font color="pink">
"ref".tr_objecttype_oty <br align="left"/>
</font>
"ref".tr_outcome_oco <br align="left"/>
"ref".tr_quality_qal <br align="left"/>
"ref".tr_rivernames_riv <br align="left"/>
"ref".tr_sex_sex <br align="left"/>
"ref".tr_species_spe <br align="left"/>
"ref".tr_timeperiod_tip <br align="left"/>
<font color="lightgreen">
"ref".tr_trait_tra <br align="left"/>
"ref".tr_traitmethod_trm <br align="left"/>
"ref".tr_traitnumeric_trn <br align="left"/>
"ref".tr_traitqualitative_trq <br align="left"/>
"ref".tr_traitvaluequal_trv <br align="left"/>
"ref".tr_units_uni <br align="left"/>
"ref".tr_version_ver
</font>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refter[fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref (ICES tables)</b> </td> </tr>
<tr> <td align="left">
"ref"."Deprecated"  <br align="left"/>
"ref"."EDMO" <br align="left"/>
"ref"."MSTAT" <br align="left"/>
"ref"."PRGOV" <br align="left"/>
"ref"."PURPM" <br align="left"/>
"ref"."StationDictionary" <br align="left"/>
"ref"."Station_DTYPE" <br align="left"/>
"ref"."WLTYP" <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refbis [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref".riversegments <br align="left"/>
"ref".tr_age_age <br align="left"/>
"ref".tr_area_are <br align="left"/>
"ref".tr_category_cat <br align="left"/>
"ref".tr_country_cou <br align="left"/>
"ref".tr_dataaccess_dta <br align="left"/>
"ref".tr_databasis_dtb <br align="left"/>
"ref".tr_datasource_dts <br align="left"/>
"ref".tr_destination_des <br align="left"/>
"ref".tr_estimationmethod_esm <br align="left"/>
"ref".tr_fishingarea_fia <br align="left"/>
"ref".tr_fishway_fiw <br align="left"/>
<font color="pink">
"ref".tr_gear_gea <br align="left"/>
</font>
"ref".tr_habitat_hab <br align="left"/>
"ref".tr_habitatlevel_lev <br align="left"/>
"ref".tr_habitattype_hty <br align="left"/>
"ref".tr_icworkinggroup_wkg <br align="left"/>
"ref".tr_lifestage_lfs <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 
}
```

<a href="https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p7/stockdb.html#species-tr_species_spe" species>Species referential</a>

::: notes
The DB uses common vocabularies, split in three parts here to be able to display.
The colors indicate work in progress, elements that only refer to the metric db, or elements cominIt uses common vocabularies, too much to display there, aligning our dictionaries with The ICES vocab has been a large part of our work, done thanks to the help of ICES data center. 
In the link, we have provided everything in the report, from our doubts and refexions, 
exchange with ICES, with working groups, the sql code and the R code to import from ICES data. Part of FAIR is being findable, and accessible, we have strived to provide this in our html reports.
:::

# The DIADROMOUS DATABASE

```{dot}
//| label: fig-schema_diaspara_withoutref
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance, pink or red colors indicate work in progress, blue color refers to the stock database, green color to the metric database.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
dat.t_stock_sto<br align="left"/>
dat.t_metadata_met<br align="left"/>
</font>
dat.t_series_ser <br align="left"/>
dat.t_serannual_san <br align="left"/>
dat.t_group_gr <br align="left"/>
dat.t_grouptrait_grt <br align="left"/>
dat.t_fish_fi <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
refeel.tg_trait_tra<br align="left"/>
refeel.tr_area_are<br align="left"/>
refeel.tr_traitmethod_trm<br align="left"/>
refeel.tr_traitnumeric_trn<br align="left"/>
refeel.tr_traitqualitative_trq<br align="left"/>
refeel.tr_traitvaluequal_trv<br align="left"/>
refeel.tr_version_ver
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<font color="blue">dateel.t_metadata_met</font> <br align="left"/>
<font color="blue">dateel.t_stock_sto</font> <br align="left"/>
dateel.t_series_ser <br align="left"/>
dateel.t_serannual_san <br align="left"/>
dateel.t_group_gr <br align="left"/>
dateel.t_grouptrait_grt <br align="left"/>
dateel.t_fish_fi <br align="left"/>
dateel.tj_seriesstation_ses <br align="left"/> </td> </tr>
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">refbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="white">
refbast.tr_area_are <br align="left"/> 
refbast.tr_estimationmethod_esm <br align="left"/> 
refbast.tr_rivernames_riv <br align="left"/> 
refbast.tr_version_ver <br align="left"/> 
</font>
<font color="pink">
refbast.tr_traitmethod_trm<br align="left"/>
refbast.tr_traitnumeric_trn<br align="left"/>
refbast.tr_traitqualitative_trq<br align="left"/>
refbast.tr_traitvaluequal_trv<br align="left"/>
</font>
</td> </tr> 
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">datbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
    datbast.t_stock_sto <br align="left"/>
    datbast.t_metadata_met <br align="left"/>
</font>
<font color="white">
    datbast.t_series_ser <br align="left"/>
    datbast.t_serannual_san <br align="left"/>
    datbast.t_group_gr <br align="left"/>
    datbast.t_grouptrait_grt <br align="left"/>
    datbast.t_fish_fi <br align="left"/>
</font> 
 </td> </tr>
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
refnas.tg_additional_add <br align="left"/>
</font>
refnas.tr_area_are <br align="left"/>
refnas.tr_rivernames_riv <br align="left"/>
refnas.tr_version_ver <br align="left"/>

</td> </tr> 
</table>> 
shape = cylinder];

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
datnas.t_stock_sto <br align="left"/>
datnas.t_metadata_met <br align="left"/>
</font>
<font color="red">
datnas.t_archive_ar <br align="left"/>
</font>

</td> </tr>
</table>> 
shape = cylinder];  

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```

::: {.notes}
So finally, if we ignore the vocabularies, we can see what has been developped so far, 
we'll come back to this in the second part, but we can see that wgeel has the full set of tables, while ...
:::


# STOCK db

![](images/copilot_stock_model.png)

::: {.notes}
Remember from yesterday, the stock DB store several things :
- regional input data aggregated at different levels but always corresponding to an area.
- stock parameters, anything from input or output of the nimble variables used in the models.
- These data might take several steps to be built, using scripts that should be transfered to TAF.
:::


## STOCK db (WGNAS)

::: {.notes}
 ***JANI*** : You started with the WGNAS database to create the stock DB, can you explain ?
::: 

:::: columns
::: {.column width="50%"}
<br>
<br>
```{=html}
<style>
    .green-box {
      background-color: green;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="green-box">
    <b> DONE <i class="fas fa-check-circle"></i></b> <br>
-  Metadata table <br>
- Stock table <br>
- Additional column for WGNAS <a href="https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p7/stockdb.html#table-of-grouping-for-area-and-age-datnas.tg_additional_add"> source </a> 
  </div>
</body>
```
:::
::::

::: {.notes}

- Metadata : 
    - Really followed the structure, dimensions accounted in vector
    - Nimble codes not completely consistent with naming by WGBAST
    - Metadata  met_old_version / deprecated might indicate change in variable, some might exist historically and be superseeded.
- stock :
    -   Country / habitat type not used
    -   Stage are more consistent than in the previous DB
    - Additional column used for variables 'eggs','p_smolt', 'p_smolt_pr', 'prop_female' in that case it's age (click on additional)
       'omega' needs an area (two columns with area) 
    - The main change is the use of areas
:::

## STOCK db (WGNAS - shiny tools- PY Hernvann)

![](images/py/upload1.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)

![](images/py/upload2.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)

![](images/py/upload3.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/upload4.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/compare_db_WG.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)

![](images/py/review_chg1.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/review_chg2.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/db_coverage1.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/db_coverage2.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)
![](images/py/db_coverage3.png){.stretch}

## STOCK db (WGNAS - shiny tools- PY Hernvann)

::: {.notes}
 ***JANI***  OK, but what consequences does the development have on this shiny application (salmoglob), will it still work ? -->
:::

## STOCK db (WGNAS)



::::: columns
::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .green-box {
      background-color: green;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="green-box">
    <b> DONE <i class="fas fa-check-circle"></i></b> <br>
- Metadata table <br>
- Stock table <br>
- Additional column for WGNAS <a href="https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p7/stockdb.html#table-of-grouping-for-area-and-age-datnas.tg_additional_add"> source </a> 
</div>
</body>
```
:::

::: {.column width="50%"}
<br> <br>

```{=html}
<style>
    .orange-box {
      background-color: orange;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="orange-box">
  <b> TODO </b> <br>
-   Include the archive db <br>
-   Import in ICES DB <br>
-   Adapt shiny app <br>
    -   R package for common tools <br>
    -   Adapt shiny <br>
  </div>
</body>
```
:::
:::::

::: notes
The database is implemented, as we see here, we need to include the archive DB,
to make the shiny comparison work. 
Now of course the development in ICES needs to be done.
We would then have to adapt the shiny app with the new code
In practise, the tools used to connect from the DB, interact with the DB, should be mutualised with a package. All WG could then use it.

:::

## STOCK db (WGEEL)

::: {.notes}
 ***JANI*** 
Very well for WGNAS, how does that work for WGEEL, which annexes of the data call have you kept ?
:::


## STOCK db (WGEEL)



::::: columns
::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .green-box {
      background-color: green;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="green-box">
    <b> DONE (test)<i class="fas fa-check-circle"></i></b> <br>
- Metadata table <br>
- Stock table <br>
  </div>
</body>
```
:::

::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .orange-box {
      background-color: orange;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="orange-box">
  <b> TODO </b> <br>
-   Latest import from WGEEL <br>
  </div>
</body>
```
:::
:::::

## STOCK db (WBAST)

![](images/clipboard-3336618413.png)


::: {.notes}
 ***JANI*** 
JANI : From what we have seen there are three DB in WGBAST, how do you adapt to this ? 
:::

## STOCK db (WBAST)


-   Change from several values column to one
-   Calendar data \< year
-   Data source
-   Qualifying the data


## STOCK db (WBAST)

::: {.notes}
 ***JANI*** 
 How would you integrate the variables needed in the bayesian model  ? 
:::


## STOCK db (WBAST)

::: {.notes}
 ***JANI*** 
  From what we have seen before, Now there is an area dimension in
WGBAST, can you show us how that works ?
:::

## STOCK db (WBAST)

**Habitat structure (Illustrate in detail the use of recursive queries to get habitat)**

## Example: River Daugava

![](images/clipboard-1464342884.png)

## Example: River Daugava & Gulf of Riga


> SELECT * FROM ref.get_parent_area(310, 'WGBAST');

![Parents from Gulf of Riga](images/clipboard-4250192328.png)

## Example: Gulf of Riga

> SELECT * FROM ref.get_parent_area(7025, 'WGBAST');

![Parents from Gulf of Riga](images/clipboard-3762430346.png)

## STOCK db (WBAST)

::::: columns
::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .green-box {
      background-color: green;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="green-box">
    <b> DONE (test)<i class="fas fa-check-circle"></i></b> <br>
- Metadata table (fisheries)<br>
- Stock table (fisheries) <br>
- Trutta dataset
- Exchange on the variables
  </div>
</body>
```
:::

::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .orange-box {
      background-color: orange;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="orange-box">
  <b> TODO </b> <br>
-   Young fish <br>
-   Mark recapture data <br>
-   ICES db coding <br>
-   Data integration (fisheries)<br>
-   Data integration (Young Fish)<br>
  </div>
</body>
```
:::
:::::


# METRIC db

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-1207399477.png){fig-align="left" width="400"}
:::

::: {.column width="60%"}
![](images/clipboard-2784958256.png){width="450"}
:::
:::::

## METRIC db (WGEEL)
::: {.notes}
 ***JANI*** 
Can you show us some details of the way you have modified the wgeel metric db to  make it both simpler and more adapted to the possible needs
:::

::::: columns
::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .green-box {
      background-color: green;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="green-box">
    <b> DONE (test)<i class="fas fa-check-circle"></i></b> <br>
- Referentials (metrics) <br>
- Merging time series <br>
  </div>
</body>
```
:::

::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .orange-box {
      background-color: orange;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="orange-box">
  <b> TODO </b> <br>
-  Latest import from WGEEL <br>
-  Work with data center
  </div>
</body>
```
:::
:::::

## METRIC db (WGNAS)

::::: columns
::: {.column .incremental width="50%"}
<br> <br>

```{=html}
<style>
    .orange-box {
      background-color: orange;
      color: black;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="orange-box">
  <b> TODO </b> <br>
-   Import WP2 (adapt to salmon) <br>
-   There is an opportunity there <br>
  </div>
</body>
```
:::

::: {.column width="50%"}
![Yellow eel time series (source WGEEL 2022)](images/yellow_eel_time_series.png)
:::
:::::

## METRIC db (WGBAST)

::: {.notes}
 ***JANI***  
 You have integrated the trutta database in the metric db, can you show us ? 
:::

## METRIC db (WGTRUTTA)

::: {.notes}
 ***JANI***  
  Based on the exchange we had with WGTRUTTA, can you explain why the metric DB would fit their use ?
:::

<a href="https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p6/wgtrutta_database_description.html#population-data"> source </a>

# Thank you !