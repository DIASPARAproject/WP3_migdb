---
title: "diaspara metric database creation script"
subtitle: "DIASPARA WP3.2 working document"
author: "Briand CÃ©dric, Oliviero Jules, Helminen Jani"
date: last-modified
date-format: "DD-MM-YYYY"
description: "Creation of metric db, version = final for WGEEL"
title-block-banner: "images/diaspara_bandeau.png"
title-block-banner-color: "white"
format:
 html:
  self-contained: true
  theme: styles.scss
  smooth-scroll: true
  fontcolor: black
  toc: true
  toc-location: left
  toc-title: Contents
  toc-depth: 3
 pdf:
  toc: true
  toc-depth: 3
  toc-title: Contents
  number-sections: true
  colorlinks: true
  documentclass: scrreprt
  pdf-engine: xelatex
  use-rsvg-convert: false
  pdf-engine-opts: ["-shell-escape"]
 latex:
  documentclass: report   
execute: 
 keep-md: true
filters:
  - include-code-files
reference-location: document
bibliography: diaspara.bib
include-after-body: "footer.html"
---





```{dot}
//| label: fig-schema_metric
//| fig-cap: Simplified structure of the metric database. The time series table, start with the series (at the bottom) which correspond to a series site or a regional monitoring program. The series contains the main attributes, including geometry, species stage ... This table is empty and filled by inheritance (---> arrows).The actual data are in the schema corresponding to each working group (pink and green). The series table can join several stations from the ICES vocab.
digraph schema {
	rankdir=TB;
	size="8,5"
    node [style=filled, fillcolor=gray, shape = record];	
    stationDictionary [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.StationDictionary</b> </td> </tr>
       <tr> <td align="left">
        sta_code (integer)  <br align="left"/>
        sta_activefromdate date <br align="left"/>
        sta_activeuntildate date </td> </tr> 
       </table>> 
       shape = Msquare];
    ts [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.series</b> </td> </tr>
       <tr> <td align="left">
        ser_id <br align="left"/>
        ...    </td> </tr> 
       </table>> 
       shape = record];
    metts [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b> dat.metadata-series</b> </td> </tr>
       <tr>
       <td align="left"><i>These are metadata</i><br/>
           <i>created during benchmark</i><br/>
           <i>probably not in DB</i><br/>
        </td>        
      </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       ...     </td> </tr> 
       </table>> 
       shape = folder];
    station_ts_join [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b> dat.series-station-join </b> </td> </tr>
       <tr>
      <td><i>One series can have multiple stations</i></td>          
        <!-- New row below the bold header -->
      </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       StationCode <br align="left"/>
       </td> </tr> 
       </table>> 
       shape = folder];    
   ann [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.annual-series</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       year  <br align="left"/>  
       ...   </td> </tr> 
       </table>> 
       shape = record];    
   grouptrait [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.grouptrait</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       year   <br align="left"/>
       mean size <br align="left"/>
       ... </td> </tr> 
       </table>> 
       shape = record];
   group [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.group</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       gr_id   <br align="left"/>
       year   <br align="left"/>       
       ... </td> </tr> 
       </table>> 
       shape = record];   
   fish [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.fish</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       fi_id   <br align="left"/>
       x   <br align="left"/>
       y   <br align="left"/>
       date <br align="left"/>
       ... </td> </tr> 
       </table>> 
       shape = record];
   indtrait
 [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.individualmetrics</b> </td> </tr>
       <tr> <td align="left">
       fi_id  <br align="left"/>
       metric_id  <br align="left"/>
       value  <br align="left"/> </td> </tr> 
       </table>> 
       shape = record];
   trait [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait</b> </td> </tr>
       <tr> <td align="left">     
       metric_id (length, weight..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitqal [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait_qualitative</b> </td> </tr>
       <tr> <td align="left">     
       trait_code (Sex, Pigment stage..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitnum [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait_numeric</b> </td> </tr>
       <tr> <td align="left">     
       trait_code (Length_mm, Weight_g..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record];  
    traitmethod [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.traitmethod</b> </td> </tr>
       <tr> <td align="left">     
       Sex (Gonadal inspection), Sex (length based)..  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitqalvalue [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.traitqalvalue</b> </td> </tr>
       <tr> <td align="left">     
       traitqalcode (pigment stage, sex..)  <br align="left"/>
       qalValue (VB, M(male), F(female))
        </td> </tr> 
       </table>> 
       shape = record];               
   tseel [fillcolor="pink"
       label="dateel.series"
       shape = table];   
   mettseel [fillcolor="pink"
       label="dateel.metadata-series"
       shape = folder];
   anneel [fillcolor="pink"
       label="dat.annual-series"
       shape = record]; 
   grouptraiteel [fillcolor="pink"
       label="dateel.grouptrait"
       shape = record];  
   indtraiteel [fillcolor="pink"
       label="dateel.indtrait"
       shape = record]; 
   fisheel [fillcolor="pink"
       label="dateel.fish"
       shape = record];
   traiteel [fillcolor="pink"
       label="dateel.trait"
       shape = record];       
   tsnas [fillcolor="limegreen"
       label="datnas.series"
       shape = table];   
   indtraitnas [fillcolor="limegreen"
       label="datnas.indtrait"
       shape = record]; 
   fishnas [fillcolor="limegreen"
       label="datnas.fish"
       shape = record]; 
  traitnas [fillcolor="limegreen"
       label="datnas.trait"
       shape = record];  

  station_ts_join -> ts [label = "n:1"]
  station_ts_join -> stationDictionary  [label = "1:n"]
  ann ->  ts [label = "n:1"]
  grouptrait -> group->  ts [label = "n:1"]
  indtrait -> fish -> ts [label = "n:1"]
  indtrait -> trait [label = "n:1"]
  indtrait -> traitqalvalue [label = "n:1"]
  indtrait -> traitmethod [label = "n:1"]
  grouptrait -> trait [label = "n:1"]
  grouptrait -> traitqalvalue [label = "n:1"]
  grouptrait -> traitmethod [label = "n:1"]
  grouptrait -> anneel [label = "implicit (year - ser_id)", style="dashed"]
  trait -> traitnum [label="inherits", style="dashed"]
  trait -> traitqal [label="inherits", style="dashed"]
  traitqalvalue -> traitqal [label = "n:1"]
  grouptraiteel -> metanneel [label = "n:1"]
  anneel -> tseel [label = "n:1"]

  indtraiteel -> fisheel -> tseel  [label = "n:1"]
  


  indtraitnas -> fishnas -> tsnas  [label = "n:1"]

  grouptraiteel -> grouptrait [label="inherits", style="dashed"]
  indtraiteel -> indtrait [label="inherits", style="dashed"]
  indtraitnas -> indtrait [label="inherits", style="dashed"]
  fisheel -> fish [label="inherits", style="dashed"]
  fishnas -> fish [label="inherits", style="dashed"] 
  anneel -> ann [ label="inherits", style="dashed"]
  tseel -> ts [ label="inherits", style="dashed"]
  tsnas -> ts [ label="inherits", style="dashed", labelOverlay="15%"]
  mettseel -> metts [label="inherits", style="dashed"]
  traiteel -> trait [label="inherits", style="dashed"]
  traitnas -> trait [label="inherits", style="dashed"]
  group  // make the same rank

  {rank = same; tseel;tsnas}
}
```


```{dot}
//| label: fig-schema_diadromous_db
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate an import of data from existing 
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref"."Deprecated"  <br align="left"/>
"ref"."EDMO" <br align="left"/>
"ref"."MSTAT" <br align="left"/>
"ref"."PRGOV" <br align="left"/>
"ref"."PURPM" <br align="left"/>
"ref"."StationDictionary" <br align="left"/>
"ref"."Station_DTYPE" <br align="left"/>
"ref"."WLTYP" <br align="left"/>
"ref".riversegments <br align="left"/>
"ref".tr_age_age <br align="left"/>
"ref".tr_area_are <br align="left"/>
"ref".tr_category_cat <br align="left"/>
"ref".tr_country_cou <br align="left"/>
"ref".tr_dataaccess_dta <br align="left"/>
"ref".tr_databasis_dtb <br align="left"/>
"ref".tr_datasource_dts <br align="left"/>
"ref".tr_destination_des <br align="left"/>
"ref".tr_estimationmethod_esm <br align="left"/>
"ref".tr_fishingarea_fia <br align="left"/>
"ref".tr_fishway_fiw <br align="left"/>
<font color="pink">
"ref".tr_gear_gea <br align="left"/>
</font>
"ref".tr_habitat_hab <br align="left"/>
"ref".tr_habitatlevel_lev <br align="left"/>
"ref".tr_habitattype_hty <br align="left"/>
"ref".tr_icworkinggroup_wkg <br align="left"/>
"ref".tr_lifestage_lfs <br align="left"/>
"ref".tr_maturity_mat <br align="left"/>
"ref".tr_metric_mtr <br align="left"/>
"ref".tr_missvalueqal_mis <br align="left"/>
"ref".tr_monitoring_mon <br align="left"/>
"ref".tr_nimble_nim <br align="left"/>
<font color="pink">
"ref".tr_objecttype_oty <br align="left"/>
</font>
"ref".tr_outcome_oco <br align="left"/>
"ref".tr_quality_qal <br align="left"/>
"ref".tr_rivernames_riv <br align="left"/>
"ref".tr_sex_sex <br align="left"/>
"ref".tr_species_spe <br align="left"/>
"ref".tr_timeperiod_tip <br align="left"/>
<font color="lightgreen">
"ref".tr_trait_tra <br align="left"/>
"ref".tr_traitmethod_trm <br align="left"/>
"ref".tr_traitnumeric_trn <br align="left"/>
"ref".tr_traitqualitative_trq <br align="left"/>
"ref".tr_traitvaluequal_trv <br align="left"/>
"ref".tr_units_uni <br align="left"/>
"ref".tr_version_ver
</font>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
dat.t_stock_sto<br align="left"/>
dat.t_metadata_met<br align="left"/>
</font>
dat.t_series_ser <br align="left"/>
dat.t_serannual_san <br align="left"/>
dat.t_group_gr <br align="left"/>
dat.t_grouptrait_grt <br align="left"/>
dat.t_fish_fi <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
refeel.tg_trait_tra<br align="left"/>
refeel.tr_area_are<br align="left"/>
refeel.tr_traitmethod_trm<br align="left"/>
refeel.tr_traitnumeric_trn<br align="left"/>
refeel.tr_traitqualitative_trq<br align="left"/>
refeel.tr_traitvaluequal_trv<br align="left"/>
refeel.tr_version_ver
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<font color="blue">dateel.t_metadata_met</font> <br align="left"/>
<font color="blue">dateel.t_stock_sto</font> <br align="left"/>
dateel.t_series_ser <br align="left"/>
dateel.t_serannual_san <br align="left"/>
dateel.t_group_gr <br align="left"/>
dateel.t_grouptrait_grt <br align="left"/>
dateel.t_fish_fi <br align="left"/>
dateel.tj_seriesstation_ses <br align="left"/> </td> </tr>
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">refbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="white">
refbast.tr_area_are <br align="left"/> 
refbast.tr_estimationmethod_esm <br align="left"/> 
refbast.tr_rivernames_riv <br align="left"/> 
refbast.tr_version_ver <br align="left"/> 
</font>
<font color="pink">
refbast.tr_traitmethod_trm<br align="left"/>
refbast.tr_traitnumeric_trn<br align="left"/>
refbast.tr_traitqualitative_trq<br align="left"/>
refbast.tr_traitvaluequal_trv<br align="left"/>
</font>
</td> </tr> 
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">datbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
    datbast.t_stock_sto <br align="left"/>
    datbast.t_metadata_met <br align="left"/>
</font>
<font color="white">
    datbast.t_series_ser <br align="left"/>
    datbast.t_serannual_san <br align="left"/>
    datbast.t_group_gr <br align="left"/>
    datbast.t_grouptrait_grt <br align="left"/>
    datbast.t_fish_fi <br align="left"/>
</font> 
 </td> </tr>
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
refnas.tg_additional_add <br align="left"/>
</font>
refnas.tr_area_are <br align="left"/>
refnas.tr_rivernames_riv <br align="left"/>
refnas.tr_version_ver <br align="left"/>

</td> </tr> 
</table>> 
shape = cylinder];

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
datnas.t_stock_sto <br align="left"/>
datnas.t_metadata_met <br align="left"/>
</font>
<font color="red">
datnas.t_archive_ar <br align="left"/>
</font>

</td> </tr>
</table>> 
shape = cylinder];  

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```

```{dot}
//| label: fig-schema_diadromousdb
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance, pink or red colors indicate work in progress, blue color refers to the stock database, green color to the metric database.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref"."Deprecated"  <br align="left"/>
"ref"."EDMO" <br align="left"/>
"ref"."MSTAT" <br align="left"/>
"ref"."PRGOV" <br align="left"/>
"ref"."PURPM" <br align="left"/>
"ref"."StationDictionary" <br align="left"/>
"ref"."Station_DTYPE" <br align="left"/>
"ref"."WLTYP" <br align="left"/>
"ref".riversegments <br align="left"/>
"ref".tr_age_age <br align="left"/>
"ref".tr_area_are <br align="left"/>
"ref".tr_category_cat <br align="left"/>
"ref".tr_country_cou <br align="left"/>
"ref".tr_dataaccess_dta <br align="left"/>
"ref".tr_databasis_dtb <br align="left"/>
"ref".tr_datasource_dts <br align="left"/>
"ref".tr_destination_des <br align="left"/>
"ref".tr_estimationmethod_esm <br align="left"/>
"ref".tr_fishingarea_fia <br align="left"/>
"ref".tr_fishway_fiw <br align="left"/>
<font color="pink">
"ref".tr_gear_gea <br align="left"/>
</font>
"ref".tr_habitat_hab <br align="left"/>
"ref".tr_habitatlevel_lev <br align="left"/>
"ref".tr_habitattype_hty <br align="left"/>
"ref".tr_icworkinggroup_wkg <br align="left"/>
"ref".tr_lifestage_lfs <br align="left"/>
"ref".tr_maturity_mat <br align="left"/>
"ref".tr_metric_mtr <br align="left"/>
"ref".tr_missvalueqal_mis <br align="left"/>
"ref".tr_monitoring_mon <br align="left"/>
"ref".tr_nimble_nim <br align="left"/>
<font color="pink">
"ref".tr_objecttype_oty <br align="left"/>
</font>
"ref".tr_outcome_oco <br align="left"/>
"ref".tr_quality_qal <br align="left"/>
"ref".tr_rivernames_riv <br align="left"/>
"ref".tr_sex_sex <br align="left"/>
"ref".tr_species_spe <br align="left"/>
"ref".tr_timeperiod_tip <br align="left"/>
<font color="lightgreen">
"ref".tr_trait_tra <br align="left"/>
"ref".tr_traitmethod_trm <br align="left"/>
"ref".tr_traitnumeric_trn <br align="left"/>
"ref".tr_traitqualitative_trq <br align="left"/>
"ref".tr_traitvaluequal_trv <br align="left"/>
"ref".tr_units_uni <br align="left"/>
"ref".tr_version_ver
</font>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
dat.t_stock_sto<br align="left"/>
dat.t_metadata_met<br align="left"/>
</font>
dat.t_series_ser <br align="left"/>
dat.t_serannual_san <br align="left"/>
dat.t_group_gr <br align="left"/>
dat.t_grouptrait_grt <br align="left"/>
dat.t_fish_fi <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
refeel.tg_trait_tra<br align="left"/>
refeel.tr_area_are<br align="left"/>
refeel.tr_traitmethod_trm<br align="left"/>
refeel.tr_traitnumeric_trn<br align="left"/>
refeel.tr_traitqualitative_trq<br align="left"/>
refeel.tr_traitvaluequal_trv<br align="left"/>
refeel.tr_version_ver
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<font color="blue">dateel.t_metadata_met</font> <br align="left"/>
<font color="blue">dateel.t_stock_sto</font> <br align="left"/>
dateel.t_series_ser <br align="left"/>
dateel.t_serannual_san <br align="left"/>
dateel.t_group_gr <br align="left"/>
dateel.t_grouptrait_grt <br align="left"/>
dateel.t_fish_fi <br align="left"/>
dateel.tj_seriesstation_ses <br align="left"/> </td> </tr>
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">refbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="white">
refbast.tr_area_are <br align="left"/> 
refbast.tr_estimationmethod_esm <br align="left"/> 
refbast.tr_rivernames_riv <br align="left"/> 
refbast.tr_version_ver <br align="left"/> 
</font>
<font color="pink">
refbast.tr_traitmethod_trm<br align="left"/>
refbast.tr_traitnumeric_trn<br align="left"/>
refbast.tr_traitqualitative_trq<br align="left"/>
refbast.tr_traitvaluequal_trv<br align="left"/>
</font>
</td> </tr> 
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">datbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
    datbast.t_stock_sto <br align="left"/>
    datbast.t_metadata_met <br align="left"/>
</font>
<font color="white">
    datbast.t_series_ser <br align="left"/>
    datbast.t_serannual_san <br align="left"/>
    datbast.t_group_gr <br align="left"/>
    datbast.t_grouptrait_grt <br align="left"/>
    datbast.t_fish_fi <br align="left"/>
</font> 
 </td> </tr>
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
refnas.tg_additional_add <br align="left"/>
</font>
refnas.tr_area_are <br align="left"/>
refnas.tr_rivernames_riv <br align="left"/>
refnas.tr_version_ver <br align="left"/>

</td> </tr> 
</table>> 
shape = cylinder];

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
datnas.t_stock_sto <br align="left"/>
datnas.t_metadata_met <br align="left"/>
</font>
<font color="red">
datnas.t_archive_ar <br align="left"/>
</font>

</td> </tr>
</table>> 
shape = cylinder];  

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```


```{dot}
//| label: fig-schema_diaspara_simplified
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refbast</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr>  
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datbast</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder]; 

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder]; 

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref


}
```

```{dot}
//| label: fig-schema_diaspara_ref
//| fig-cap: Referential only split in three parts.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];

ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref".tr_lifestage_lfs <br align="left"/>
"ref".tr_maturity_mat <br align="left"/>
"ref".tr_metric_mtr <br align="left"/>
"ref".tr_missvalueqal_mis <br align="left"/>
"ref".tr_monitoring_mon <br align="left"/>
"ref".tr_nimble_nim <br align="left"/>
<font color="pink">
"ref".tr_objecttype_oty <br align="left"/>
</font>
"ref".tr_outcome_oco <br align="left"/>
"ref".tr_quality_qal <br align="left"/>
"ref".tr_rivernames_riv <br align="left"/>
"ref".tr_sex_sex <br align="left"/>
"ref".tr_species_spe <br align="left"/>
"ref".tr_timeperiod_tip <br align="left"/>
<font color="lightgreen">
"ref".tr_trait_tra <br align="left"/>
"ref".tr_traitmethod_trm <br align="left"/>
"ref".tr_traitnumeric_trn <br align="left"/>
"ref".tr_traitqualitative_trq <br align="left"/>
"ref".tr_traitvaluequal_trv <br align="left"/>
"ref".tr_units_uni <br align="left"/>
"ref".tr_version_ver
</font>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refter[fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref (ICES tables)</b> </td> </tr>
<tr> <td align="left">
"ref"."Deprecated"  <br align="left"/>
"ref"."EDMO" <br align="left"/>
"ref"."MSTAT" <br align="left"/>
"ref"."PRGOV" <br align="left"/>
"ref"."PURPM" <br align="left"/>
"ref"."StationDictionary" <br align="left"/>
"ref"."Station_DTYPE" <br align="left"/>
"ref"."WLTYP" <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refbis [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td align="left">
"ref".riversegments <br align="left"/>
"ref".tr_age_age <br align="left"/>
"ref".tr_area_are <br align="left"/>
"ref".tr_category_cat <br align="left"/>
"ref".tr_country_cou <br align="left"/>
"ref".tr_dataaccess_dta <br align="left"/>
"ref".tr_databasis_dtb <br align="left"/>
"ref".tr_datasource_dts <br align="left"/>
"ref".tr_destination_des <br align="left"/>
"ref".tr_estimationmethod_esm <br align="left"/>
"ref".tr_fishingarea_fia <br align="left"/>
"ref".tr_fishway_fiw <br align="left"/>
<font color="pink">
"ref".tr_gear_gea <br align="left"/>
</font>
"ref".tr_habitat_hab <br align="left"/>
"ref".tr_habitatlevel_lev <br align="left"/>
"ref".tr_habitattype_hty <br align="left"/>
"ref".tr_icworkinggroup_wkg <br align="left"/>
"ref".tr_lifestage_lfs <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 
}
```


```{dot}
//| label: fig-schema_diaspara_withoutref
//| fig-cap: Structure of the schema in diaspara. Dashed arrow indicate inheritance, pink or red colors indicate work in progress, blue color refers to the stock database, green color to the metric database.
digraph schema {
rankdir=TB;
size="8,5"
node [style=filled, fillcolor=gray, shape = record];
ref [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>ref</b> </td> </tr>
<tr> <td> ... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

dat [fillcolor="gray"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dat</b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
dat.t_stock_sto<br align="left"/>
dat.t_metadata_met<br align="left"/>
</font>
dat.t_series_ser <br align="left"/>
dat.t_serannual_san <br align="left"/>
dat.t_group_gr <br align="left"/>
dat.t_grouptrait_grt <br align="left"/>
dat.t_fish_fi <br align="left"/>
... <br align="left"/> </td> </tr> 
</table>> 
shape = cylinder]; 

refeel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refeel</b> </td> </tr>
<tr> <td align="left">
refeel.tg_trait_tra<br align="left"/>
refeel.tr_area_are<br align="left"/>
refeel.tr_traitmethod_trm<br align="left"/>
refeel.tr_traitnumeric_trn<br align="left"/>
refeel.tr_traitqualitative_trq<br align="left"/>
refeel.tr_traitvaluequal_trv<br align="left"/>
refeel.tr_version_ver
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dateel [fillcolor="pink"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dateel</b> </td> </tr>
<tr> <td align="left">
<font color="blue">dateel.t_metadata_met</font> <br align="left"/>
<font color="blue">dateel.t_stock_sto</font> <br align="left"/>
dateel.t_series_ser <br align="left"/>
dateel.t_serannual_san <br align="left"/>
dateel.t_group_gr <br align="left"/>
dateel.t_grouptrait_grt <br align="left"/>
dateel.t_fish_fi <br align="left"/>
dateel.tj_seriesstation_ses <br align="left"/> </td> </tr>
</table>> 
shape = cylinder];

refbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">refbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="white">
refbast.tr_area_are <br align="left"/> 
refbast.tr_estimationmethod_esm <br align="left"/> 
refbast.tr_rivernames_riv <br align="left"/> 
refbast.tr_version_ver <br align="left"/> 
</font>
<font color="pink">
refbast.tr_traitmethod_trm<br align="left"/>
refbast.tr_traitnumeric_trn<br align="left"/>
refbast.tr_traitqualitative_trq<br align="left"/>
refbast.tr_traitvaluequal_trv<br align="left"/>
</font>
</td> </tr> 
</table>> 
shape = cylinder];

datbast [fillcolor="purple"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b><font color="white">datbast</font></b> </td> </tr>
<tr> <td align="left">
<font color="lightblue">
    datbast.t_stock_sto <br align="left"/>
    datbast.t_metadata_met <br align="left"/>
</font>
<font color="white">
    datbast.t_series_ser <br align="left"/>
    datbast.t_serannual_san <br align="left"/>
    datbast.t_group_gr <br align="left"/>
    datbast.t_grouptrait_grt <br align="left"/>
    datbast.t_fish_fi <br align="left"/>
</font> 
 </td> </tr>
</table>> 
shape = cylinder];

refnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>refnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
refnas.tg_additional_add <br align="left"/>
</font>
refnas.tr_area_are <br align="left"/>
refnas.tr_rivernames_riv <br align="left"/>
refnas.tr_version_ver <br align="left"/>

</td> </tr> 
</table>> 
shape = cylinder];

datnas [fillcolor="limegreen"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>datnas</b> </td> </tr>
<tr> <td align="left">
<font color="blue">
datnas.t_stock_sto <br align="left"/>
datnas.t_metadata_met <br align="left"/>
</font>
<font color="red">
datnas.t_archive_ar <br align="left"/>
</font>

</td> </tr>
</table>> 
shape = cylinder];  

reftrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>reftrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];

dattrutta [fillcolor="tan1"
label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
<tr> <td> <b>dattrutta</b> </td> </tr>
<tr> <td align="left">
<br align="left"/>
<br align="left"/>
</td> </tr> 
</table>> 
shape = cylinder];   

 # this in an archive


refeel -> ref [style="dashed"]
refbast -> ref [style="dashed"]
refnas -> ref [style="dashed"]
reftrutta -> ref [style="dashed"]
dateel -> dat [style="dashed"]
datnas -> dat [style="dashed"]
datbast -> dat [style="dashed"]
dattrutta -> dat [style="dashed"]
dateel -> refeel
datnas -> refnas
dattrutta -> reftrutta
datbast  -> refbast
dateel -> ref
datnas -> ref
dattrutta -> ref
datbast  -> ref
}
```

# Stockdb, fig area hierarchy
```{dot}
//| label: fig-area_hierarchy
//| fig-cap: The nested structure layed out in table tr_area_area, dotted box indicate that the level is optional. This table will be created specifically for each group.


digraph {
compound=true;
newrank=true;

subgraph clusterA {
label = Panpopulation
style=full
color=black
center=true

subgraph clusterB {
label = Complex
style=dashed
color=black
center=true

subgraph clusterC {
label = Stock
style=dashed
color=black
center=true

subgraph clusterD {
label = Country
style=dashed
color=firebrick
fontcolor=firebrick
center=true

subgraph clusterE {
label = Assessment_unit
style=full
color=green 
fontcolor=green

subgraph clusterF {
label = Regional;
style=dashed
color=green4
fontcolor=green4

subgraph clusterG {
label = River
style=dashed
color=green3
fontcolor=green3

subgraph clusterH {
label = River_section
style=dashed
color=green2
fontcolor=green2
section [
label=data,
shape=box, 
style =invis
]
}
}
}
}
}
}
subgraph clusterZ{
label=Major
style=dashed
color=royalblue4
fontcolor=royalblue4

subgraph clusterY{
label=Subareas
style=dashed
color=royalblue3
fontcolor=royalblue3

subgraph clusterX{
label=Division
style=dashed
color=royalblue2
fontcolor=royalblue2

subgraph clusterW{
label=Sudivision
style=full
color=royalblue1
fontcolor=royalblue1

subgraph clusterV{
label=Unit
style=dashed
color=deepskyblue
fontcolor=deepskyblue

Fishing [
style=invis]
}
}
}
}            
}          
}}}
```