---
title: "wgbast database description"
subtitle: "DIASPARA WP3.2 working document"
author: "Briand Cédric, Oliviero Jules, Helminen Jani"
date: last-modified
date-format: "DD-MM-YYYY"
description: "Technical analysis of the wgbast database"
title-block-banner: "images/diaspara_bandeau.png"
title-block-banner-color: "white"
format:
 html:
  self-contained: true
  theme: cosmo
  smooth-scroll: true
  fontcolor: black
  toc: true
  toc-location: left
  toc-title: Summary
  toc-depth: 3
reference-location: document
bibliography: ../diaspara.bib
---



The following working document is just a technical analysis of the WGBAST database. It uses different sources, ICES vocabulary, the stock annex [@ICES2021_wgbast_stock_annex], to analyse the structure of the wgbast database before integrating in a single database (wgnas, wgbast, wgeel) in the DIASPARA project.
This document does not engage the WGBAST it's just a technical analysis, to try to get how this works.
This document is listed as a task there :
https://github.com/DIASPARAproject/WP3_migdb/issues/11


# Spatial units

## River stock

 “river stock” correspond salmon that belongs to a particular river. In most cases, river stocks most likely correspond to biological populations which lend support for this level of division from a conservation genetic perspective. However, it should be noted that some larger rivers may harbour several salmon subpopulations that are genetically separated spatially and/or temporally (Lind et al. 2015) [@ICES2021_wgbast_stock_annex]. 

### Salmon population
According to the results of Säisä et al. (2005), there are three main groups of salmon populations in the Baltic Sea: 1) Gulf of Bothnia populations, 2) populations in southern Sweden, and 3) eastern populations (Gulf of Finland and eastern Main Basin). These groups or lineages are assumed to mirror three distinct post-glacial colonization events. About 5% of the total genetic diversity of the Baltic salmon is explained by differences between rivers within groups, whereas 6% is explained by differences between the lineages (Säisä et al., 2005) [@ICES2021_wgbast_stock_annex].

### Assessment units within the Baltic Sea area

Within the Baltic Sea area, currently six different assessment units (AUs) have been established (Figure A.1.1.1). The grouping of rivers within an assessment unit is based on management objectives and biological and genetic characteristics of the river stocks contained in a unit. The partition of rivers into assessment units needs to make sense from a management perspective. River stocks of a particular unit are believed to exhibit similar migration patterns at sea. It can therefore be assumed that they are subjected to the same sea fisheries, experience the same exploitation rates and are affected by management of sea fisheries in the same way. In addition, the genetic variability between river stocks of an assessment unit is smaller than the genetic variability between river stocks of different units (see above). Although the rivers of assessment units 5 and 6 are relatively small in terms of their production capacity compared with rivers in the other assessment units, they are very important from a conservation perspective because of their unique genetic background.
The six assessment units in the Baltic Sea consist of:

 * 1 )	Northeastern Bothnian Bay river stocks, starting at Perhonjoki up till the river Råneälven.
 * 2 )	Western Bothnian Bay river stocks, starting at Lögdeälven up to Luleälven.
 * 3 )	Bothnian Sea river stocks, from Dalälven up to Gideälven and from Paimionjoki up to Kyrönjoki.
 * 4 )	Western Main Basin river stocks, i.e. southeastern part of Sweden.
 * 5 )	Eastern Main Basin river stocks, i.e. rivers in Estonia, Latvia and Lithuania.
 * 6 )	Gulf of Finland river stocks.
Wild river stocks belonging to each assessment unit are listed in the next section[@ICES2021_wgbast_stock_annex].
  

![Grouping of salmon river stocks in six assessment units in the Baltic Sea. The genetic variability between river stocks of an assessment unit is smaller than the genetic variability between river stocks of different units. In addition, the river stocks of a particular unit exhibit similar migration patterns. Wild salmon rivers (dark blue), mixed salmon rivers (light blue), reared salmon rivers (red), river stretches not accessible for salmon (grey). (source wgbast stock annex)](images/assessment_units_wgbast.jpg){#fig-assessmentunits}

> [QUESTION WGBAST] Could we have access to a gis of this map (river type) to create the referentials in WP3.1 habitat

### ICES vocab linked with catchments in the Baltic.
```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_migdb/R")
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_migdb/R")
}
source("utilities/load_library.R")
load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
```
``` {r icesVocabrivers}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: = ICES Vocab for River and Catchments (RiversAndCatchments)
#| tbl-subcap:
#|   - RiverAndCatchments, 10 first lines
#|   - This row has a problem
#| label: tbl-vocab_riverandcatchment
types <- icesVocab::getCodeTypeList()
types[grep('river', tolower(types$Description)),]
RiversAndCatchments <- icesVocab::getCodeList('RiversAndCatchments')
nrow(RiversAndCatchments)
kable(RiversAndCatchments[1:10,]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
kable(RiversAndCatchments[is.na(RiversAndCatchments$key),]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

Note the url in this table (@tbl-vocab_riverandcatchment): 	https://opendata-download.smhi.se/svar/SVAR_Basprodukter_2016_6.pdf is no longer accessed anywhere, and there is a NA without value. 
It does not seems as if there is a hierarchy in these geographic units.

> [NOTE ICES] Just for information there is a line with NA ?, also the link is no longer valid.

>  [TODO] We'll have to reconcile this table with GIS,  we have to if there is a GIS map somewhere in ICES.

>  [TODO] link ICES codes in our referential (which will be a map polygon in postgis).

> [NOTE] River stock, assessment units and rivers align with the envisioned db hierachical structure for spatial data.

### Category of rivers




|     Category of salmon river               |     Management plan for salmon stock in the   river     |     Releases                                  |     Criteria for wild smolt production    |
|--------------------------------------------|---------------------------------------------------------|-----------------------------------------------|-------------------------------------------|
|     Wild                                   |     Self-sustaining                                     |     No continuous releases                    |     >90% of total smolt prod.             |
|     Mixed                                  |     Not self-sustaining at these production   levels    |     Releases occur                            |     10–90% of total smolt prod.           |
|     Reared                                 |     Not self-sustaining                                 |     Releases occur                            |     <10% of total smolt prod.             |
|     Potential leading to category wild     |     Lead to self-sustaining river stock                 |     Releases occur during re-establishment    |     Long-term >90% wild smolt prod.       |
|     Potential leading to category mixed    |     Not self-sustaining river stock                     |     Releases occur                            |     Long-term 10–90% wild smolt prod.     |
: Classification criteria for wild, mixed, reared and potential salmon rivers in the Baltic Sea [@ICES2021_wgbast_stock_annex] {#tbl-classificationrivers}

> [NOTE] The rivers are stored in the db, but these details (@tbl-classificationrivers) might vary within one basin (see @fig-assessmentunits), maybe this information should be stored alongside the referential as a separate table assessing the category of river but also including a period, as the status might change over time ?

# Fishery

```{r read_catch_db}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Vilaine/Projets/DIASPARA/wgbast"
catchdb <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Catch_29-02-2024.xlsx"), sheet = "Catch data")
catchdb <- janitor::clean_names(catchdb)
# quick fix to avoid logical I put char in subdiv_IC[1]
catchdb$subdiv_ic[1]<-NA
catchdb %>%skim()
```

## Year 
```{r year}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
unique(catchdb$year)
```


## Other timeperiod


```{r tp_type}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
table(catchdb$time_period, catchdb$tp_type)
sum(is.na(catchdb$tp_type))
sum(is.na(catchdb$time_period))
```

> [QUESTION WGBAST] Can you confirm that `MON` and `MONTH` are the same values, same for `Year` and `YR` ? `HYR` and `QTR` are half of year and quarter OK

> [NOTE] Add constraint according to tp_type. Also add a not null constraint.

## Country

Two letter country codes.
```{r country}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
unique(catchdb$country)
```

## Species

```{r species}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
table(catchdb$species)
catchdb[catchdb$species=="NA",]%>%
 head(2) %>%
 kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) 
catchdb[catchdb$species=="SAL&TRS",]%>%
 head(2) %>%
 kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```





> [QUESTION WGBAST] Some 'NA' are character (11 rows) for EE. This is for seal damage and not reported the same way every year ? 

## Catch  habitat

Countries participating in the Baltic salmon fishery are asked to deliver catch data of salmon and sea trout. Catches are given by economic zone, ICES subdivision, as well as type of fishery separated by `offshore, coastal and river` [@ICES2021_wgbast_stock_annex]. 

Catches are divided into four different fishing area categories: `River (R), Coastal (C), Open sea (O) and Sea (S)`. `Sea (S)` is only used when it is not possible to separate between coast and open sea. There is no standardized way of distributing sea catches into either of the two WGBAST fishing area categories Coast (C) or Open sea (O). For the commercial fisheries, a majority of the countries divide the commercial landings on fishing area depending on which gear that has been used, where longlines and driftnets are categorised as open sea (O) and trapnets as coastal (C) [@ICES2021_wgbast_stock_annex]. 

Exceptions: 

 * In Latvia, the distribution is depending on how the catches are reported into the official catch statistics. Here catches from vessels carrying EU logbook are categorised as open sea (O), whereas catches from vessels reporting in the national logbook system are categorised as coastal (C). Latvian vessels that are active 2 nautical miles (NM) or more off the coast are obliged to use EU logbook.

 *	In Lithuania, catches outside territorial water, i.e. 12 NM or more from the coast, are categorised as open sea (O). Inside this border catches are categorised as coastal (C).

 *	In Poland, length of the vessel defines if the catch is coastal (C) or open sea (O). Catches from vessels 10 meters or less are coastal (C) and catches from vessels longer than 10 meters are categorised as open sea (O).

Latvia and Lithuania are the only two countries directly using the actual geographical position when categorising the catches as either coastal (C) or open sea (O).
For the recreational fisheries, all countries define trolling as open sea (O) whereas catches from other gears are defined as coastal (C) [@ICES2021_wgbast_stock_annex]. 




``` {r checkdbhabitat}
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
unique(catchdb$fishery)
sum(is.na(catchdb$fishery))
head(catchdb[is.na(catchdb$fishery),])
table(catchdb$fishery, catchdb$sub_div) %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
vcd::doubledecker(fishery ~  species + sub_div, data = catchdb)
```

> [QUESTION WGBAST] In the stock annex there is a mention to sea `S` but it does not seem to be present in the database ?

Some areas do not hold a lot of catch for rivers. 

The best match for fishery habitat in ICES is WLTYP.

``` {r icesVocabhabitat}
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
WLTYP <- icesVocab::getCodeList('WLTYP')
kable(WLTYP, caption = "Water type (for stations)") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

> [QUESTION ICES] Is that right ? Should we use this one ? Is there really a need to add `sea` with a definition : catches either MO or C as it does not seem to be used ? 

> [QUESTION WGBAST] Currently the definition in ICES vocab is WFD coastal water (C) or MC (Marine water (coast)) Marine water within 4 nm from the baseline. It seems that there are country difference in the interpretation of coastal or marine 2 10 12, so what do we choose ?

## Catches type

Catches are further classified as `commercial, recreational, discard, and seal damage`[@ICES2021_wgbast_stock_annex]. The excel tables gives more types than the stock annex : `commercial=COMM, recreational=RECR, discard=DISC, sealdamage=SEAL, unreported=UNRP, ALV=released alive back in water`


> NOTE : There is a difference between the stock annex, the stock annex lists four types, `UNRP` does not exist and should be removed from the excel describing the column content, `ALV` is found in the table (as in the db description), `BROOD` is never described

> [QUESTION WGBAST] 39 lines with `BROOD` do you know to what these correspond ?


``` {r checkFTYPE}
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
table(catchdb$f_type, useNA="ifany",dnn = "f_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```

## Source of fishery data

Logbooks provide primary information on catches taken on board the vessels, where real count and weight estimates are normally difficult to obtain. The catch statistics in different countries are obtained by combination of data included in logbooks, landing declarations, first sales notes and fisheries companies catch reports. From 2005 EU type logbooks were implemented in the new member states Latvia, Estonia, Poland and Lithuania [@ICES2021_wgbast_stock_annex].

In the excel table the possible values are indicated as :
`logbook=LOG, extrapolated=EXT, estimated=EST, expert evaluation=EXP`



The ICES vocab DataSourceOfScientificWeight seems to provide the closest match with these data, however it lacks extrapolated, estimated.



``` {r checknTYPE}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
table(catchdb$n_type, useNA="ifany",dnn = "n_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
table(catchdb$n_type, catchdb$f_type, useNA="ifany") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

> [QUESTION WGBAST] What are the definitions of extrapolated and estimated. ? 

> [QUESTION WGBAST] ARE `EXP` and `EXV` the same ? What is `GST` ?

> [QUESTION WGBAST] The source of fishery data might partially correspond to the vocab dataSourceOfScientificWeight. At least there is a `Logbook`, `Expert evaluation`,  any idea if something in this vocab might correspond to extrapolated or estimated ? 

> [QUESTION WGBAST] Do you want to allow NA values there  ?

> [QUESTION WGBAST] Would you treat things differently if tables for Baltic TRUTTA and  SALMON were separated ?

``` {r checkwTYPE}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
table(catchdb$w_type, useNA="ifany",dnn = "n_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
table(catchdb$n_type, catchdb$f_type, useNA="ifany") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```


This is very similar to n_type this is 

``` {r icesVocabsource}
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
DataSourceOfScientificWeight <- icesVocab::getCodeList('DataSourceOfScientificWeight')
kable(DataSourceOfScientificWeight, caption = "DataSourceOfScientificWeight table") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

# Electrofishing and river data 

```{r read_young_fishdb_db}
#| eval: FALSE
#| echo: TRUE
#| warning: FALSE
#| message: FALSE 
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Vilaine/Projets/DIASPARA/wgbast"
smolts <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Young_fish_26-02-2024.xlsx"), sheet = "number of wild smolts")
young_fish <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Young_fish_26-02-2024.xlsx"), sheet = "numb of young fish")
smolts <- janitor::clean_names(smolts)
young_fish <- janitor::clean_names(young_fish)
# quick fix to avoid logical I put char in subdiv_IC[1]

smolts %>%skim()
young_fish %>%skim()
sy <- bind_rows(
smolts %>% 
mutate(
  tab="smolts",
  the_most_probable_number_of_smolts = as.numeric(the_most_probable_number_of_smolts),
),
young_fish %>% 
mutate(
  tab = "young_fish",
  sub_div = as.character(sub_div),
  sub_div3 = as.character(sub_div3),
  min_numb_of_wild_smolts = as.numeric(min_numb_of_wild_smolts),
  max_numb_of_wild_smolts = as.numeric(max_numb_of_wild_smolts),
  n_type = as.numeric(n_type)
))
save(sy, file= "data/sy.Rdata")
```

> [NOTE] R1168C15 3,4 (probably two values....) probably need correction


Electrofishing data are obtained along with smolt counts at rivers Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven and Lögdeälven (Assessment unit 1-3), Mörrumsån, Emån and Testeboån (AU 4) to estimate smolt production based on parr density in electrofishing.

* Annual number of sampling sites electrofished
* Estimated density of age 0+
* 1+ 
* \>1+ parr. 

The number of sampling sites is used as a measure of precision of the parr density. 

> [Question WGBAST] there must be a dataset of electrofishing somewhere. This should be part of the template db on electrofishing, can we have access ?

> [Question  WGBAST] would it be usefull to start from a full db of electrofishing data ?


## species

```{r young_fishdb_db_species}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
load("data/sy.Rdata")

table(sy$species, sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```
## country

Years distributed from 1984, nothing special (Table @tbl-yearyoungfish), this db does not use time periods lower than year.
## time 
```{r young_fishdb_dbtime}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: = Number of values per year and sheet in the database
#| label: tbl-yearyoungfish
table(sy$year,sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
## geography
```{r young_fishdb_db_geo}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
# TODO assessment unit
# TODO sub_div
# TODO sub_div2
# TODO sub_div3
# TODO river

table(sy$species, sy$river) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
## river_category

```{r young_fishdb_db_river_cat}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
# TODO river_category

```



## age
```{r read_young_fish_db_age}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 

```
## origin

```{r young_fishdb_db_origin}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
origin
```


![Overview of the different types of data available for the different Baltic salmon stocks. The table also indicates for which stocks the current assessment methodology is estimating smolt abundance, spawner abundance and associated stock–recruit function. River categories: W=wild, M=mixed, R=reared. (source wgbast stock annex)](images/table_data_wgbast.png)

# The model

Salmon populations in Gulf of Bothnia and southern Sweden (AUs 1–4), eastern Main Basin (AU5) and Gulf of Finland (AU6) are assessed separately [@ICES2021_wgbast_stock_annex].

![Overview of the assessment methodology for Baltic salmon stocks. The results from five uppermost analyses provide informative prior probability distributions for the full life-history model. These priors become automatically updated by the information contained in the data and by the biological knowledge of the Baltic salmon life cycle used to build a full life-history model. PSPC=Potential Smolt Production Capacity. Note that smolt trapping data is available from more rivers than indicated in the figure. (source wgbast stock annex)](images/assessement_method.jpg)


# Mark recapture

Mark–recapture experiments combined with smolt trapping have been used in eleven rivers (Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven, Lögdeälven, Testeboån, Mörrumsån and Emån). 

* number of untagged fish caught by the smolt trap
*  the number of tagged smolts released upstream from the trap
*  number of recaptured tagged smolts. 
* different time intervals, like days, or annual totals
* daily water level 
* water temperature data

Sea marking recapture


![Schematic presentation of the mark–recapture model for Baltic salmon. The offshore driftnet and longline fisheries in the Baltic Main Basin are assumed to take place in October and December, respectively. During the migration to the spawning grounds, the salmon can be intercepted by the coastal driftnet fishery in May, the trapnet and gillnet fisheries in June and the river fishery in August (Michielsens et al., 2006a).(source wgbast stock annex)](images/marking_recapture_sea_wgbast.png)





# Parameters

* `K`maximum smolt production (K, i.e. the smolt production that would be obtained with an infinite number of spawners under the Beverton–Holt model). Lognormal distributions with median and coefficient of variation matching with the ones of exact distributions are used for approximation. K priors are river specific. They might change (data call specific values can be stored each year).
* Individual expert judgement on the productivity of each rivers for :
  * chance for successfull spawing
  * habitat quality of parr area
  * smoltification age
  * mortality during migration
  * size of production area
* the model produces a probabilistic justification for the expert views of salmon smolt production
  * parr density capacity (5 discrete classes from the poorest river in the Northern Baltic area to the best river in the Baltic).
  * pre-smolt density capacity (5 classes).
  * smolt production capacity.

* Yearly smolt production for the rivers Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven, Lögdeälven, Testeboån and Mörrumsån.
* Smolt abundance estimated forall other rivers in AU1-4 for which only parr density estimates are available, based on the hierarchical linear regression analysis 
* Mark–recapture analysis : independent estimates of relative parr density and smolt abundance in a form of statistics of posterior distributions. Medians and CV.
* Maturation rates, 
* Natural mortality rates, 
* Mortality  F [year, age, category, fishery] 
  * where fishery is :
    * offshore driftnet
    * offshore longline
    * coastal driftnet
    * trapnet and gillnet 
    * river fishery
  * And category is :
    * wild / hatchery raised
* Annual yolk sack mortality,
* Annual M74 yolk sack mortality
* Stock recruitment posterior distribution 
* proportion of MSW (multi-sea-winter) spawners encountered in the rivers Tornionjoki, Kalixälven, Byskeälven, Ume/Vindelälven, Öreälven and Piteälven
* model-predicted catches are raised by the proportions of smolts produced in assessment units  5 and 6 (not yet been included in the model) compared with the total smolt production of all units.
* the relative occurrence of wild vs. reared salmon in catches 
* Sex ratio (annually changing) for multi-sea-winter salmon for Ume/Vindelälven 
* Sex ratio per stock (outside from Ume/Vindelälven)
* egg/female per stock  
* ... might have missed a lot of things !


