---
title: "wgbast database description"
subtitle: "DIASPARA WP3.2 working document"
author: "Briand Cédric, Oliviero Jules, Helminen Jani"
date: last-modified
date-format: "DD-MM-YYYY"
description: "Technical analysis of the wgbast database"
title-block-banner: "images/diaspara_bandeau.png"
title-block-banner-color: "white"
format:
 html:
  self-contained: true
  theme: styles.scss
  smooth-scroll: true
  fontcolor: black
  toc: true
  toc-location: left
  toc-title: Summary
  toc-depth: 3
execute: 
 keep-md: true
reference-location: document
bibliography: diaspara.bib
include-after-body: "footer.html"
---



The following working document is just a technical analysis of the WGBAST database. It uses different sources, ICES vocabulary, the stock annex [@ICES2021_wgbast_stock_annex], to analyse the structure of the wgbast database before assessing whether we could integrate it in a single database (wgnas, wgbast, wgeel) in the DIASPARA project.
This document does not engage the WGBAST it's to try to get how this works.
At this stage answers were kindly provided by Tapani.
This document is listed as a task there [github link to diaspara](https://github.com/DIASPARAproject/WP3_migdb/issues/11)


# Spatial units

## River stock

 “river stock” correspond salmon that belongs to a particular river. In most cases, river stocks most likely correspond to biological populations which lend support for this level of division from a conservation genetic perspective. However, it should be noted that some larger rivers may harbour several salmon subpopulations that are genetically separated spatially and/or temporally (Lind et al. 2015) [@ICES2021_wgbast_stock_annex]. 

### Salmon population
According to the results of Säisä et al. (2005), there are three main groups of salmon populations in the Baltic Sea: 1) Gulf of Bothnia populations, 2) populations in southern Sweden, and 3) eastern populations (Gulf of Finland and eastern Main Basin). These groups or lineages are assumed to mirror three distinct post-glacial colonization events. About 5% of the total genetic diversity of the Baltic salmon is explained by differences between rivers within groups, whereas 6% is explained by differences between the lineages (Säisä et al., 2005) [@ICES2021_wgbast_stock_annex].

### Assessment units within the Baltic Sea area

Within the Baltic Sea area, currently six different assessment units (AUs) have been established (Figure A.1.1.1). The grouping of rivers within an assessment unit is based on management objectives and biological and genetic characteristics of the river stocks contained in a unit. The partition of rivers into assessment units needs to make sense from a management perspective. River stocks of a particular unit are believed to exhibit similar migration patterns at sea. It can therefore be assumed that they are subjected to the same sea fisheries, experience the same exploitation rates and are affected by management of sea fisheries in the same way. In addition, the genetic variability between river stocks of an assessment unit is smaller than the genetic variability between river stocks of different units (see above). Although the rivers of assessment units 5 and 6 are relatively small in terms of their production capacity compared with rivers in the other assessment units, they are very important from a conservation perspective because of their unique genetic background.
The six assessment units in the Baltic Sea consist of:

 * 1 )	Northeastern Bothnian Bay river stocks, starting at Perhonjoki up till the river Råneälven.
 * 2 )	Western Bothnian Bay river stocks, starting at Lögdeälven up to Luleälven.
 * 3 )	Bothnian Sea river stocks, from Dalälven up to Gideälven and from Paimionjoki up to Kyrönjoki.
 * 4 )	Western Main Basin river stocks, i.e. southeastern part of Sweden.
 * 5 )	Eastern Main Basin river stocks, i.e. rivers in Estonia, Latvia and Lithuania.
 * 6 )	Gulf of Finland river stocks.
Wild river stocks belonging to each assessment unit are listed in the next section[@ICES2021_wgbast_stock_annex].
  

![Grouping of salmon river stocks in six assessment units in the Baltic Sea. The genetic variability between river stocks of an assessment unit is smaller than the genetic variability between river stocks of different units. In addition, the river stocks of a particular unit exhibit similar migration patterns. Wild salmon rivers (dark blue), mixed salmon rivers (light blue), reared salmon rivers (red), river stretches not accessible for salmon (grey). (source wgbast stock annex)](images/assessment_units_wgbast.jpg){#fig-assessmentunits}


:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST
::::
::::{.questionbox-body}
Could we have access to a gis of this map (river type) to create the referentials in WP3.1 habitat
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
Jānis Bajinskis has produced this map and kindly provided .shp
::::
:::


### ICES vocab linked with catchments in the Baltic.
```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Eaux&Vilaine/Projets/DIASPARA/wgbast"
}
source("utilities/load_library.R")
load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
```
``` {r icesVocabrivers}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: = ICES Vocab for River and Catchments (RiversAndCatchments)
#| tbl-subcap:
#|   - RiverAndCatchments, 10 first lines
#|   - This row has a problem
#| label: tbl-vocab_riverandcatchment
types <- icesVocab::getCodeTypeList()
types[grep('river', tolower(types$Description)),]
RiversAndCatchments <- icesVocab::getCodeList('RiversAndCatchments')
nrow(RiversAndCatchments)
kable(RiversAndCatchments[1:10,]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
kable(RiversAndCatchments[is.na(RiversAndCatchments$key),]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```
::: {.callout-note appearance="simple"}
## ICES
Note the url in this table (@tbl-vocab_riverandcatchment): 	https://opendata-download.smhi.se/svar/SVAR_Basprodukter_2016_6.pdf is no longer accessed anywhere
:::

It does not seems as if there is a hierarchy in these geographic units.

::: {.callout-note appearance="simple"}
## ICES
 Just for information there is a line with NA ?
:::

::: {.callout-tip appearance="simple"}
## TODO
 We'll have to reconcile this table with GIS. No GIS data of these at ICES. Prelim. We will do a prelim. linking to GIS data using other (scarce) sources.
:::

::: {.callout-tip appearance="simple"}
## TODO
 link ICES codes in our referential (which will be a map polygon in postgis).
:::

:::{.callout-tip appearance="simple"}
## NOTE 
River stock, assessment units and rivers align with the envisioned db hierachical structure for spatial data.
:::

### Category of rivers




|     Category of salmon river               |     Management plan for salmon stock in the   river     |     Releases                                  |     Criteria for wild smolt production    |
|--------------------------------------------|---------------------------------------------------------|-----------------------------------------------|-------------------------------------------|
|     Wild                                   |     Self-sustaining                                     |     No continuous releases                    |     >90% of total smolt prod.             |
|     Mixed                                  |     Not self-sustaining at these production   levels    |     Releases occur                            |     10–90% of total smolt prod.           |
|     Reared                                 |     Not self-sustaining                                 |     Releases occur                            |     <10% of total smolt prod.             |
|     Potential leading to category wild     |     Lead to self-sustaining river stock                 |     Releases occur during re-establishment    |     Long-term >90% wild smolt prod.       |
|     Potential leading to category mixed    |     Not self-sustaining river stock                     |     Releases occur                            |     Long-term 10–90% wild smolt prod.     |
: Classification criteria for wild, mixed, reared and potential salmon rivers in the Baltic Sea [@ICES2021_wgbast_stock_annex] {#tbl-classificationrivers}


:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST
::::
::::{.questionbox-body}
The rivers are stored in the db, but these details (@tbl-classificationrivers) might vary within one basin (see @fig-assessmentunits), maybe this information should be stored alongside the referential as a separate table assessing the category of river but also including a period, as the status might change over time ?
::::
:::

# part I - Fishery

![Catches of salmon in % of TAC in 1993-2023. For years 1993–1997 (1993–1998 for Gulf of Finland) it is not possible to divide the total reported catch into commercial and recreational catches. (source [@ices_baltic_2024])](images/landings_wgbast_report2024){#fig-landings}


```{r read_catch_db}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
catchdb <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Catch_29-02-2024.xlsx"), sheet = "Catch data")
catchdb <- janitor::clean_names(catchdb)
# quick fix to avoid logical I put char in subdiv_IC[1]
catchdb$subdiv_ic[1]<-NA
catchdb %>%skim()
```

## Year 
```{r year}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
unique(catchdb$year)
```


## Other timeperiod


```{r tp_type}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: = Table of timpe periods in the wgbast db
#| label: tbl-catchdatatime

table(catchdb$time_period, catchdb$tp_type) %>%
 kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```
There are `r sum(is.na(catchdb$tp_type))` and `r sum(is.na(catchdb$time_period))` NA values for `tp_type`.


:::{.callout-note  appearance="simple"}
## NOTE
`HYR` and `QTR` are half of year and quarter
:::

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST
::::
::::{.questionbox-body}
Could you confirm that `MON` and `MONTH` are the same values, same for `Year` and `YR` ? 
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
-	Yup, MON=MONTH and Year=YR
::::
:::

:::{.callout-tip appearance="simple"}
## TODO 
Add constraint according to tp_type. Also add a not null constraint.
:::

## Country

Two letter country codes.
```{r country}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
unique(catchdb$country)
```

## Species

```{r species}
#| echo: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Species in wgbast catch database
#| tbl-subcap:
#| - Table of Species numbers
#| - First two entries where species = NA
#| - First two entries where species = SAL&TRS
#| label: tbl-catchdataspecies 
table(catchdb$species, useNA="ifany",dnn = "species") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover"))
catchdb[catchdb$species=="NA",]%>%
 head(2) %>%
 kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover")) 
catchdb[catchdb$species=="SAL&TRS",]%>%
 head(2) %>%
 kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```



:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST : species
::::
::::{.questionbox-body}
 Some 'NA' are character (11 rows) (@tbl-catchdataspecies) for EE. This is for seal damage. Is there a need for this ? It's not reported the same way every year ? 
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
-	Estonia cannot distinguish whether seal damaged catch is SAL or TRS. Split to the species could base on expert elicitation but has remained undone.
::::
:::

## Catch  habitat

Countries participating in the Baltic salmon fishery are asked to deliver catch data of salmon and sea trout. Catches are given by economic zone, ICES subdivision, as well as type of fishery separated by `offshore, coastal and river` [@ICES2021_wgbast_stock_annex]. 

Catches are divided into four different fishing area categories: `River (R), Coastal (C), Open sea (O) and Sea (S)`. `Sea (S)` is only used when it is not possible to separate between coast and open sea. There is no standardized way of distributing sea catches into either of the two WGBAST fishing area categories Coast (C) or Open sea (O). For the commercial fisheries, a majority of the countries divide the commercial landings on fishing area depending on which gear that has been used, where longlines and driftnets are categorised as open sea (O) and trapnets as coastal (C) [@ICES2021_wgbast_stock_annex]. 

Exceptions: 

 * In Latvia, the distribution is depending on how the catches are reported into the official catch statistics. Here catches from vessels carrying EU logbook are categorised as open sea (O), whereas catches from vessels reporting in the national logbook system are categorised as coastal (C). Latvian vessels that are active 2 nautical miles (NM) or more off the coast are obliged to use EU logbook.

 *	In Lithuania, catches outside territorial water, i.e. 12 NM or more from the coast, are categorised as open sea (O). Inside this border catches are categorised as coastal (C).

 *	In Poland, length of the vessel defines if the catch is coastal (C) or open sea (O). Catches from vessels 10 meters or less are coastal (C) and catches from vessels longer than 10 meters are categorised as open sea (O).

Latvia and Lithuania are the only two countries directly using the actual geographical position when categorising the catches as either coastal (C) or open sea (O).
For the recreational fisheries, all countries define trolling as open sea (O) whereas catches from other gears are defined as coastal (C) [@ICES2021_wgbast_stock_annex]. 




``` {r tbl-catchdatahabitat}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Habitat and fishery
#| tbl-subcap: 
#|   - Habitat type in column `fishery` in wgbast catch database. Rows correspond to the values in sub_div, columns to habitat type
#|   - Contingency table for `sub_div`and `sub_div2` including NA
#|   - Contingency table for `sub_div2`and `sub_div3` including NA


table(catchdb$sub_div, catchdb$fishery, useNA="ifany") %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

  table(catchdb$sub_div, catchdb$sub_div2, useNA="ifany") %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

  table(catchdb$sub_div2, catchdb$sub_div3, useNA="ifany") %>% kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

``` {r fig-checkdbhabitat}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| fig-cap: Double dekker plot showing the importance of habitat type per species and subdivision. Cell importance according to the number of rows

vcd::doubledecker(fishery ~  species + sub_div, data = catchdb)
```

The values for habitat are : `r unique(catchdb$fishery)` 
there are `r sum(is.na(catchdb$fishery))` NA values in the database.
200=MainB(22-29); 300=GoB(30-31).


:::{.callout-note appearance="simple"}
## TODO
Create geographical grouping of areas + use ICES subdiv3
:::



:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST : habitat
::::
::::{.questionbox-body}
* In the stock annex there is a mention to sea `S` but 
it does not seem to be present in the database ?
* The name of the column `fishery`is not very explicit, would the use of `habitat_type` 
be more in line with data ?
* Can you confirm that 200 is 22-31 and not 22-29, and that 300 is 30-31 ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
In the stock annex there is an old notation. Today we use “O” (open sea) instead of “S”. 
::::
:::



The best match for fishery habitat in ICES vocabulary seems to be WLTYP.

``` {r tbl-icesVocabhabitat}
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| fig-cap: ICES vocabulary for water types (stations)

WLTYP <- icesVocab::getCodeList('WLTYP')
kable(WLTYP, caption = "Water type (for stations)") %>% 
kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 

```

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION ICES : vocabulary for habitat
::::
::::{.questionbox-body}
Should we use this vocabulary for catch habitat ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
I agree, we could use ICES vocabulary for catch habitat (i.e MO, MC, C and CR/FW)
::::
:::

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST: 4 nm from the baseline ?
::::
::::{.questionbox-body}
 Currently the definition in ICES vocab is WFD coastal water (C) or MC (Marine water (coast)) Marine water within 4 nm from the baseline. It seems that there are country difference in the interpretation of coastal or marine 2 10 12, so what do we choose ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
In the WGBAST thinking we have only one coastal water category independently from the distance to the baseline. All trapnet fishing is considered coastal even though fishing sites may varies from very close to shoreline out to beyond base line. At the Finnish coast baseline goes far out at sea in some places. 
::::
:::

:::{.callout-note appearance="simple"}
## NOTE WGBAST
Currently subdivisions are used but for some historical data it is not possible to separate ICES subdivisions, so for these historical data these data are lumped together.
:::

## Catches type (f_type)

Catches are further classified as `commercial, recreational, discard, and seal damage` 
[@ICES2021_wgbast_stock_annex]. The excel tables gives more types than the stock annex :
 `commercial=COMM, recreational=RECR, discard=DISC, sealdamage=SEAL, unreported=UNRP, 
 ALV=released alive back in water`.


``` {r tbl-checkftype}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Frequency of catches classification `f_type` in the database.
table(catchdb$f_type, useNA="ifany",dnn = "f_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION WGBAST: what are 'BMS' and 'BROOD' ?
::::
::::{.questionbox-body}
There is a difference between the stock annex, the excel table and the database. The stock annex lists four types `COMM`, `RECR`, `DISC` and `SEAL`. The excel also describes `ALV`, `UNRP` which does not exist. The db has two additional types `BROOD` and `BMS` which are reported neither in the stock annex nor in the excel table. These correspond to very few lines. Do you want to keep those values? Do you agree that `UNRP` should not be in the excel description ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
The Stock annex seems to miss part of catch categories. 
* BROOD means broodstock fishery and BMS is catch of undersized salmon (below minimum landing size, landing obligation). 
* ALV is caught fish that has been releases back to sea/river alive. UNRP is unreported catch. 
* At some point intention was to include unreported catch estimates to the catch data but has not realised so far. Might be OK to drop from the excel description. 
::::
:::


### Missing values for f_type (historical dataset)

There are `r sum(is.na(catchdb$f_type))` missing values for f_type.
We need some help there. Some data are historical, they are reported in sub_div 200, 300, or 32 from 1972
to 1999. There is one line for F (Freswater) one line for O and C (Marine habitat). Always weights.

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::

::::
::::{.questionbox-body}
QUESTION WGBAST (National correspondents): Is it OK to attribute COMM to C and O and RECR to F ?
Or do we need to create another type like HIST for historical data ? 
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::

::::
::::{.answerbox-body}
TODO
::::
:::


``` {r tbl-missingftype_1}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Data without f_type for the historical dataset in FI and SE.
catchdb |> filter(is.na(f_type) & year < 2000) |>
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```


### Missing values for f_type (recent dataset)

Here we have less lines, and the data structure is not aggregated to 200, 300, 32.
There must be some mistakes.

``` {r tbl-missingftype_2}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Data without f_type for the historical dataset in FI and SE.
catchdb |> filter(is.na(f_type) & year >= 2000) |>
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```
:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
::::
::::{.questionbox-body}
QUESTION WGBAST (National correspondents): Is it OK to attribute COMM to C and O and RECR to F ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST (Henni)
::::
::::{.answerbox-body}
National correspondents need to answer this one => OK we'll do...
::::
:::

## Source of fishery data

Logbooks provide primary information on catches taken on board the vessels, where real count and weight estimates are normally difficult to obtain. The catch statistics in different countries are obtained by combination of data included in logbooks, landing declarations, first sales notes and fisheries companies catch reports. From 2005 EU type logbooks were implemented in the new member states Latvia, Estonia, Poland and Lithuania [@ICES2021_wgbast_stock_annex].

In the excel table the possible values are indicated as :
`logbook=LOG, extrapolated=EXT, estimated=EST, expert evaluation=EXP`.



The ICES vocab `DataSourceOfScientificWeight` seems to provide the closest match with these data, however it lacks extrapolated, estimated.



``` {r tbl-checkntype}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Catches according to source of capture and outcome `f_type` in the WGNAS fisheries database.
#| tbl-subcap: 
#|   - Frequency of each type in the database including NA
#|   - Contingency table for `n_type`and `f_type`including NA
table(catchdb$n_type, useNA="ifany",dnn = "n_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
table(catchdb$n_type, catchdb$f_type, useNA="ifany") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```


``` {r tbl-icesVocabsource}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: ICES vocabulary for `DataSourceOfScientificWeight`.
DataSourceOfScientificWeight <- icesVocab::getCodeList('DataSourceOfScientificWeight')
kable(DataSourceOfScientificWeight, caption = "DataSourceOfScientificWeight table") %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
QUESTION / ANSWERS WGBAST
::::
::::{.questionbox-body}
* Could you provide definitions of extrapolated and estimated. ?

> Need to come back to this later on

* ARE `EXP` and `EXV` the same (@tbl-checkntype) ? 

> Yes, they are the same. 

* What is `GST` (@tbl-checkntype)?

> All GST -values should be updated as “expert evaluated”.

* The source of fishery data might partially correspond to the vocab `dataSourceOfScientificWeight` (@tbl-icesVocabsource). At least there is a `Logbook`, `Expert evaluation`,  any idea if something in this vocab might correspond to extrapolated or estimated ? 

> The “Combcd” might do best for these.

* Do you want to allow NA values there  ?

> No, I don't think so. Better to give a value from vocab here.

* Would you treat things differently if tables for Baltic TRUTTA and  SALMON were separated ?

> No, not to my understanding
::::
:::


:::{.callout-note appearance="simple"}
## NOTE
`w_type`and `n_type` source of data are similar and will be treated in the same column in the database 
There are `r sum(is.na(catchdb$w_type))` NA values for `w_type`.
:::



``` {r tbl-checkwtype}
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| tbl-cap: Catches according to data source for weight `w_type` in the WGNAS fisheries database.
#| tbl-subcap: 
#|   - Frequency of each type datasource for weight in the database including NA
#|   - Contingency table for `n_type`and `w_type`including NA
table(catchdb$w_type, useNA="ifany",dnn = "w_type") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
table(catchdb$n_type, catchdb$w_type, useNA="ifany") %>%
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
```


## gear

TODO analyse gear according to ftype


# Part II. Electrofishing and river data 


The data are read from the WGBAST_2024_Young_fish xlsx file. This file has two sheets. The number of young fish is the number of fish released in water (stocking), and the smolt corresponds to smolts counts.

```{r read_youngfishdbdb}
#| eval: TRUE
#| echo: TRUE
#| warning: FALSE
#| message: FALSE 

smolts <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Young_fish_26-02-2024.xlsx"), sheet = "number of wild smolts")
young_fish <- readxl::read_xlsx(file.path(datawd, "WGBAST_2024_Young_fish_26-02-2024.xlsx"), sheet = "numb of young fish")
smolts <- janitor::clean_names(smolts)
young_fish <- janitor::clean_names(young_fish)

smolts %>%skim()
young_fish %>%skim()
sy <- bind_rows(
smolts %>% 
mutate(
  tab="smolts",
  the_most_probable_number_of_smolts = as.numeric(the_most_probable_number_of_smolts),
),
young_fish %>% 
mutate(
  tab = "young_fish",
  sub_div = as.character(sub_div),
  sub_div3 = as.character(sub_div3),
  min_numb_of_wild_smolts = as.numeric(min_numb_of_wild_smolts),
  max_numb_of_wild_smolts = as.numeric(max_numb_of_wild_smolts),
  n_type = as.numeric(n_type)
))
save(sy, file= "data/sy.Rdata")
```

:::{.callout-note appearance="simple"}
## NOTE WGBAST
 R1168C15 3,4 (probably two values....) probably need correction
:::

Electrofishing data are obtained along with smolt counts at rivers Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven and Lögdeälven (Assessment unit 1-3), Mörrumsån, Emån and Testeboån (AU 4) to estimate smolt production based on parr density in electrofishing.

* Annual number of sampling sites electrofished
* Estimated density of age 0+
* 1+ 
* \>1+ parr. 

The number of sampling sites is used as a measure of precision of the parr density. 

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question WGBAST
::::
::::{.questionbox-body}
* There must be a dataset of electrofishing somewhere. This should be part of the template db on electrofishing, can we have access ?
* Would it be usefull to start from a full db of electrofishing data ?
::::
:::

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
There is an input dataset for the river model. This has been compiled from the national data set for 17 rivers (that are included in the full life history model at present). In other words that dataset is missing AU5-6 rivers, which parr densities and the corresponding smolt production estimates are presented in the WGBAST report tables only. Atso knows more about this.

Yes, I think this would be good. Would it be possible to apply same data construction for SAL, TRS and EEL ?

> Yes we think so and will try
::::
:::

## Species

```{r tbl-youngfishdbdbspecies}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Frequencies of species type in the young fish and smolt database.
load("data/sy.Rdata")

table(sy$species, sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Country

```{r tbl-youngfishdbdbcountry}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Countries in the young fish and smolt database.
load("data/sy.Rdata")

table(sy$country, sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


## Time 
```{r tbl-youngfishdbdbtime}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Number of values per year and sheet in the database
table(sy$year,sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
:::{.callout-note appearance="simple"}
## NOTE 
Years distributed from 1984, nothing special (Table tbl-youngfishdbdbtime), this db does not use time periods lower than year.
:::


## Geography
```{r tbl-youngfishdbdbgeo}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Geographical units in the young fish and smolt database
#| tbl-subcap: 
#|   - Rivers (note that some labels seem to be duplicated in the database)
#|   - Duplicated values for name in ICES vocab
#|   - Rivers with more than one ICES division
#|   - Table for values corresponding to more than one ICES division


table(sy$river, sy$tab) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Joining rivers and the ICES vocab, the idea is to get rid of the 
# accents, but then ICES vocab has duplicated values. I'm stopping there....
# 
# sy %>% 
# select(river) %>% 
# distinct(river)  %>% 
# mutate(river0=stringi::stri_trans_general(river, "latin-ascii")) %>% 
# filter(river != river0)
RR <- RiversAndCatchments %>% 
 mutate(description0 = 
        stringi::stri_trans_general(Description, "latin-ascii"))
## this is gona be hard, there are duplicated names in description in the ICES Vocab
RR[RR$description0%in%RR[duplicated(RR$description0),"description0"],] %>%
 arrange(Description) %>% kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cc <- apply(as.data.frame.matrix(table(sy$river, sy$sub_div)),1,function(X)sum(X>0))
dd <- data.frame("more_than_1_ICES_div"=cc[cc > 1])
dd %>% arrange(more_than_1_ICES_div) %>% kable() 

sydd <- sy %>% filter (river %in% rownames(dd))
table(sydd$river, sydd$sub_div) %>% kable %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
 


```


:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question / ANSWERS WGBAST
::::
::::{.questionbox-body}
* Could you please confirm the duplicated values here (values with similar names)
in @tbl-youngfishdbdbgeo. 

> Yes, there are dublicates (with minor differences in writing). Need to check river by river.

* Why are some entries for some rivers corresponding to more than one area ?

> No, there should not be such as long as the key value in ICES vocab will be used. River name (“Description”) don't always specify the river because several rivers/brooks may have the same name. 
::::
:::


## River_category

```{r tbl-youngfishdbdbrivercat}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: River categories in the young fish and smolt database
table(sy$river_category, sy$tab, useNA="ifany") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```



## Age
```{r tbl-readyoungfishdbage}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Age in the young fish database
#| tbl-subcap: 
#|   - Age for smolts
#|   - Age for young fish
sys <- sy %>% filter(tab=="smolts") 
table(sys$age,sys$species ) %>% kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

syy <- sy %>% filter(tab=="young_fish") 
table(syy$age, syy$species) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question WGBAST
::::
::::{.questionbox-body}
* What is the meaning of the different age categories ?
* There are 9 lines in the smolts database who have a stage corresponding to 1s parr Are these caught in downstream traps ?
::::
:::


:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
In this you have smolts and parr corresponding to release of aquaculture raised salmons. `2s`should be replaced by `2 s parr`. yr correspond to 1yr old smolt. 1 yr parr correspond to parr relase at 1 yr old. There are very few parr in hatcheries that will not have smoltified at 2 yr (2yr parr), most will smoltify at age 1 so that's why the number are low. Fry correspond to alevins with the yolk sack. 
::::
:::

## Origin

```{r tbl-youngfishdbdborigin}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Origin in the young fish and smolt database
table(sy$origin, sy$tab, useNA="ifany") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question / ANSWERS WGBAST
::::
::::{.questionbox-body}
There are just 9 NA values, is this an error ?

> NA are errors. 
::::
:::



## Type of smolt number estimation method


1. Complete count of smolts.
2. Sampling of smolts and estimate of total smolt run size.
3. Estimate of smolt run from parr production by relation developed in the same river.
4. Estimate of smolt run from parr production by relation developed in another river.
5. Inference of smolt production from data derived from similar rivers in the region.
6. Count of spawners.
7. Estimate inferred from stocking of reared fish in the river.
8. Salmon catch, exploitation and survival estimate.

```{r ntype}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Origin in the young fish and smolt database
summary(sy$n_type)
```
:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
WGBAST
::::
::::{.questionbox-body}
* NOTE There are character values, "na", "n.e.","0,3", "0 .1"  
* QUESTION There are missing values there ... Is that correct ?

> -	Need to look closer all cases to be able to evaluate 
::::
:::

```{r tbl-youngfishdbdborigin}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Origin in the young fish and smolt database
table(sy$origin, sy$tab, useNA="ifany") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

The n_type are not consistent for one river accross time, with a lot of NA.

```{r tbl-youngfishdbdbntyperiver}
#| echo: FALSE
#| eval: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Origin in the young fish and smolt database
sy |> group_by(species,river, year, n_type ) |>
   summarize(n()) |>
  kable() |>
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# part III - TRUTTA electrofishing densities dataset

```{r read_truttadensitiesdb}
#| eval: TRUE
#| echo: TRUE
#| warning: FALSE
#| message: FALSE 
truttadens <- readxl::read_xlsx(file.path(datawd, "WGBAST_TRS_densities2024filled.xlsx"), sheet = "dane")[,1:9]
ttd <- janitor::clean_names(truttadens)
ttd <- ttd[!is.na(ttd$density_n_100m2),]

ttd %>%skim()
```


## Species

```{r tbl-truttadensitiesdbspecies}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Frequencies of species type in the trutta densities dataset
#| tbl-subcap: 
#|   - Frequency of values
#|   - Lines with missing value for species

table(ttd$species, useNA="ifany") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

ttd[is.na(ttd$species),] %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

:::{.callout-note appearance="simple"}
## NOTE WGBAST
Two values without species, we can correct while integrating
:::


## Country

```{r tbl-truttadensitiesdbcountry}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Countries in the trutta density dataset


table(ttd$country, useNA="ifany" ,dnn = "country") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question WGBAST
::::
::::{.questionbox-body}
* GER should be DE

> Yes

* What is SE-S, it's not a country how do we deal with this. Why is it needed ? Could we use some other column from the other datasets (as they will be in the joined database structure) ?

> This is notation for the assessment unit southern Sweden. Should not be used as the country value.
::::
:::

## Time 
```{r tbl-truttadensitiesdbtime}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Number of values per year and sheet in trutta density dataset
table(ttd$year, useNA="ifany", dnn = "country") %>% 
 kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
:::{.callout-note appearance="simple"}
## NOTE 
Years distributed from 1975, nothing special (Table @tbl-truttadensitiesdbtime), this db does not use time periods lower than year.
:::


## Age

```{r tbl-truttadensitiesage}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Age in the trutta density dataset

table(ttd$age , useNA="ifany", dnn="age") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


```

:::{.answerbox}
::::{.answerbox-header}
::::{.answerbox-icon}
::::
ANSWER WGBAST
::::
::::{.answerbox-body}
Yes for Trutta the ages are divided between 0+ and older than 0+ which is a grouping of several ages.
::::
:::

## Geography
```{r tbl-truttadensitiesdbgeo}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE 
#| tbl-cap: Geographical units in the trutta densities dataset
#| tbl-subcap: 
#|   - Rivers (note that some labels seem to be duplicated in the database)
#|   - Rivers, main_river, and country
#|   - Rivers with more than one ICES division
#|   - Table for values corresponding to more than one ICES division
#|   - Table of main rivers

table(ttd$river, useNA="ifany", dnn = "river") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


ttd %>% group_by(river,main_river, country)  %>% summarize(N=n()) %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cc <- apply(as.data.frame.matrix(table(ttd$river, ttd$sub_div)),1,function(X)sum(X>0))
dd <- data.frame("more_than_1_ICES_div"=cc[cc > 1])
dd %>% arrange(more_than_1_ICES_div) %>% kable() 

ttddd <- ttd %>% filter (river %in% rownames(dd))
table(ttddd$river, ttddd$sub_div) %>% kable %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
 
table(ttd$main_river, useNA="ifany", dnn = "main_river") %>% 
  kable() %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question / answers WGBAST
::::
::::{.questionbox-body}
* Would it be usefull to start from a full db of electrofishing data ?

> Yes, I thing would be good. Like for SAL electrofishing data too. 

* Could you please confirm the duplicated values here (values with similar names)
in @tbl-truttadensitiesdbgeo. 

> Potentially dublicates, but several rivers/brooks may have the same name.

* Do you have GIS information corresponding to those rivers ?

> - The gis information is available in national geographic data bases. For example the Finnish Environmental Institute host the data concerned.

* Some values are 'at sea' what does it means ?

> These are release to the marine water at the coast away from any river mouth (no imprinting to the river).

* Why are some entries for some rivers corresponding to more than one area ?

> by river names yes but not if key code is used
::::
:::

:::{.questionbox}
::::{.questionbox-header}
::::{.questionbox-icon}
::::
Question ICES
::::
::::{.questionbox-body}
* There are  duplicated names in the ICES Vocab, is it the same rivers ?
Do you have ways to separate the rivers (gis information) ?

> ANSWER WGBAST : The key code of the ICES vocab separates the rivers, not the river names (“Description”).
::::
:::


# part IV The model

![Overview of the different types of data available for the different Baltic salmon stocks. The table also indicates for which stocks the current assessment methodology is estimating smolt abundance, spawner abundance and associated stock–recruit function. River categories: W=wild, M=mixed, R=reared. (source wgbast stock annex)](images/table_data_wgbast.png)


Salmon populations in Gulf of Bothnia and southern Sweden (AUs 1–4), eastern Main Basin (AU5) and Gulf of Finland (AU6) are assessed separately [@ICES2021_wgbast_stock_annex].

![Overview of the assessment methodology for Baltic salmon stocks. The results from five uppermost analyses provide informative prior probability distributions for the full life-history model. These priors become automatically updated by the information contained in the data and by the biological knowledge of the Baltic salmon life cycle used to build a full life-history model. PSPC=Potential Smolt Production Capacity. Note that smolt trapping data is available from more rivers than indicated in the figure. (source wgbast stock annex)](images/assessement_method.jpg)







:::{.callout-note appearance="simple"}
## TODO
Look at the report 
:::

# Mark recapture

Mark–recapture experiments combined with smolt trapping have been used in eleven rivers (Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven, Lögdeälven, Testeboån, Mörrumsån and Emån). 

* number of untagged fish caught by the smolt trap
*  the number of tagged smolts released upstream from the trap
*  number of recaptured tagged smolts. 
* different time intervals, like days, or annual totals
* daily water level 
* water temperature data

Sea marking recapture


![Schematic presentation of the mark–recapture model for Baltic salmon. The offshore driftnet and longline fisheries in the Baltic Main Basin are assumed to take place in October and December, respectively. During the migration to the spawning grounds, the salmon can be intercepted by the coastal driftnet fishery in May, the trapnet and gillnet fisheries in June and the river fishery in August (Michielsens et al., 2006a).(source wgbast stock annex)](images/marking_recapture_sea_wgbast.png)





# Parameters

* `K`maximum smolt production (K, i.e. the smolt production that would be obtained with an infinite number of spawners under the Beverton–Holt model). Lognormal distributions with median and coefficient of variation matching with the ones of exact distributions are used for approximation. K priors are river specific. They might change (data call specific values can be stored each year).
* Individual expert judgement on the productivity of each rivers for :
  * chance for successfull spawing
  * habitat quality of parr area
  * smoltification age
  * mortality during migration
  * size of production area
* the model produces a probabilistic justification for the expert views of salmon smolt production
  * parr density capacity (5 discrete classes from the poorest river in the Northern Baltic area to the best river in the Baltic).
  * pre-smolt density capacity (5 classes).
  * smolt production capacity.

* Yearly smolt production for the rivers Tornionjoki, Simojoki, Åbyälven, Rickleån, Sävarån, Ume/Vindelälven, Öreälven, Lögdeälven, Testeboån and Mörrumsån.
* Smolt abundance estimated forall other rivers in AU1-4 for which only parr density estimates are available, based on the hierarchical linear regression analysis 
* Mark–recapture analysis : independent estimates of relative parr density and smolt abundance in a form of statistics of posterior distributions. Medians and CV.
* Maturation rates, 
* Natural mortality rates, 
* Mortality  F [year, age, category, fishery] 
  * where fishery is :
    * offshore driftnet
    * offshore longline
    * coastal driftnet
    * trapnet and gillnet 
    * river fishery
  * And category is :
    * wild / hatchery raised
* Annual yolk sack mortality,
* Annual M74 yolk sack mortality
* Stock recruitment posterior distribution 
* proportion of MSW (multi-sea-winter) spawners encountered in the rivers Tornionjoki, Kalixälven, Byskeälven, Ume/Vindelälven, Öreälven and Piteälven
* model-predicted catches are raised by the proportions of smolts produced in assessment units  5 and 6 (not yet been included in the model) compared with the total smolt production of all units.
* the relative occurrence of wild vs. reared salmon in catches 
* Sex ratio (annually changing) for multi-sea-winter salmon for Ume/Vindelälven 
* Sex ratio per stock (outside from Ume/Vindelälven)
* egg/female per stock  
* ... might have missed a lot of things !


