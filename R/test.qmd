---
title: "diaspara metric database creation script"
subtitle: "DIASPARA WP3.2 working document"
author: "Briand CÃ©dric, Oliviero Jules, Helminen Jani"
date: last-modified
date-format: "DD-MM-YYYY"
description: "Creation of metric db, version = final for WGEEL"
format: 
  pdf:
    toc: true
    toc-depth: 3
    toc-title: Contents
    number-sections: true
    colorlinks: true    
    mermaid-format: svg
    pdf-engine-opts: ["-shell-escape"]
filters:
  - include-code-files
bibliography: diaspara.bib
---


```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_migdb/R")
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Eaux&Vilaine/Projets/DIASPARA/wgbast"
}
source("utilities/load_library.R")
load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
load_library("RPostgres")
load_library("yaml")
load_library("DBI")
load_library("ggplot2")
load_library("sf")
load_library("janitor") # clean_names
load_library("uuid")
cred <- read_yaml("../credentials.yml")
con_diaspara <- dbConnect(Postgres(), 
                           dbname = cred$dbnamediaspara,
                           host = cred$hostdistant,
                           port = cred$port,
                           user = cred$userdiaspara,
                           password = cred$passworddiaspara)
con_diaspara_admin <- dbConnect(Postgres(), 
                                dbname = cred$dbnamediaspara,
                                host = cred$hostdistant,
                                port = cred$port,
                                user = cred$userdistant,
                                password = cred$passworddistant)
con_salmoglob <- dbConnect(Postgres(), 
                           dbname = cred$dbnamesalmo,
                           host = cred$hostdistant,
                           port = cred$port,
                           user = cred$usersalmo,
                           password = cred$passwordsalmo)
con_wgeel_distant <- dbConnect(Postgres(), 
                           dbname = cred$dbnamedistant,
                           host = cred$hostdistant,
                           port = cred$port,
                           user = cred$userdistant,
                           password = cred$passworddistant)
# con_wgeel_local <- dbConnect(Postgres(), 
#                            dbname = "wgeel",
#                            host = "127.0.0.1",
#                            port = cred$port,
#                            user = cred$userdistant,
#                            password = cred$passwordsalmo)


```

Aside the main db report, which describes all the vocabularies used in this document, we have to build a separate database for metrics. In the project these correspond to LHT, but additionally, the data should also correspond to the time series and the sampling db developed by WGEEL. The two latter data structure (series and sampling) are very similar and they both hold very similar group metrics and individual metrics.

 The first was developed initially to store data about the series used in recruitment. In practice, it consists of three tables, the `t_series_ser` (Figure @fig-series_diagram_wgeel - top in blue) table contains series id and description, with columns describing the sampling details, the stage used, the method... This is the main identifier of the series which will be used as a reference in all dependent tables. The second `t_dataseries_das` table  (Figure @fig-series_diagram_wgeel - on the right) holds data about annual values in series. These are typically annual counts for recruitment, along with additional effort data. Linked to these are group metric series used to describe the series, mean age of eel, mean size, proportion of glass eel among the yellow eels, proportion of females ... (Figure @fig-series_diagram_wgeel - in orange)
Finally, we can link individual metrics. The individual metrics are all detailed for one fish. And they concern metrics like size, weight, sex, but also can hold data about quality, contamination. So these are in essence the Life History traits analysed by WP2 in DIASPARA  (Figure @fig-series_diagram_wgeel - in pink).

![Diagram for series](images/series_diagram_wgeel.png "A sql diagram of the relations of tables for series"){#fig-series_diagram_wgeel}

The second type of data was developed to hold the data collected for DCF. These can be metrics collected from sampling by the fishermen, data coming from the analysis of electrofishing data, or other experimental sampling that are not reported as series. Currently the two structures for series and sampling are very close, the only difference is that there is no annual number linked to the sampling data, and that they are not linked to a stage in the first table, so the stage is added in the fish table.
The difference in table structure is illustrated below in tables highlighted in yellow (Figure @fig-sampling_diagram_wgeel).

![Diagram for sampling](images/sampling_diagram_wgeel.png "A sql diagram of the relations of tables for sampling"){#fig-sampling_diagram_wgeel}

The database development highlighted in the current report has several objectives :

* The first objective is to join the two database to simplify the database development and handling of data.

* The second objective is to use the new referentials created for the migdb database.

* The third objective is to import data from WP2, the excel sheets have been created in february 2025 and will already (in March) require some adaptation as the database evolves, for instance the referential of stages is no longer in line with the templates.

* The fourth objective is to hand over this database, along with the migdb to ICES, for integration in ICES database ecosystem, and use of DATSU in datacall.

* The fifth objective is to adapt the shiny scripts of data integration.

# Building database structure from WGEEL 


[git issue #23 Write simplified structure from WGEEL](https://github.com/DIASPARAproject/WP3_migdb/issues/23)

The main issue will require to merge the two table structures (sampling and series) and adapt to migdb vocabulary.

Once done a beta version probably not completely adapted will be released.

[milestone metric DB beta version](https://github.com/DIASPARAproject/WP3_migdb/milestone/6)



```{dot}
//| label: fig-schema_diaspara
//| fig-cap: Simplified structure of the metric database. The time series table, start with the series (at the bottom) which correspond to a series site or a regional monitoring program. The series contains the main attributes, including geometry, species stage ... This table is empty and filled by inheritance (---> arrows).The actual data are in the schema corresponding to each working group (pink and green). The series table can join several stations from the ICES vocab.
digraph schema {
	rankdir=TB;
	size="8,5"
    node [style=filled, fillcolor=gray, shape = record];	
    stationDictionary [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.StationDictionary</b> </td> </tr>
       <tr> <td align="left">
        sta_code (integer)  <br align="left"/>
        sta_activefromdate date <br align="left"/>
        sta_activeuntildate date </td> </tr> 
       </table>> 
       shape = Msquare];
    ts [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.series</b> </td> </tr>
       <tr> <td align="left">
        ser_id <br align="left"/>
        ...    </td> </tr> 
       </table>> 
       shape = record];
    metts [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b> dat.metadata-series</b> </td> </tr>
       <tr>
       <td align="left"><i>These are metadata</i><br/>
           <i>created during benchmark</i><br/>
           <i>probably not in DB</i><br/>
        </td>        
      </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       ...     </td> </tr> 
       </table>> 
       shape = folder];
    station_ts_join [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b> dat.series-station-join </b> </td> </tr>
       <tr>
      <td><i>One series can have multiple stations</i></td>          
        <!-- New row below the bold header -->
      </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       StationCode <br align="left"/>
       </td> </tr> 
       </table>> 
       shape = folder];    
   ann [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.annual-series</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       year  <br align="left"/>  
       ...   </td> </tr> 
       </table>> 
       shape = record];    
   grouptrait [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.grouptrait</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       year   <br align="left"/>
       mean size <br align="left"/>
       ... </td> </tr> 
       </table>> 
       shape = record];
   group [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.group</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       gr_id   <br align="left"/>
       year   <br align="left"/>       
       ... </td> </tr> 
       </table>> 
       shape = record];   
   fish [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.fish</b> </td> </tr>
       <tr> <td align="left">
       ser_id  <br align="left"/>
       fi_id   <br align="left"/>
       x   <br align="left"/>
       y   <br align="left"/>
       date <br align="left"/>
       ... </td> </tr> 
       </table>> 
       shape = record];
   indtrait
 [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>dat.individualmetrics</b> </td> </tr>
       <tr> <td align="left">
       fi_id  <br align="left"/>
       metric_id  <br align="left"/>
       value  <br align="left"/> </td> </tr> 
       </table>> 
       shape = record];
   trait [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait</b> </td> </tr>
       <tr> <td align="left">     
       metric_id (length, weight..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitqal [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait_qualitative</b> </td> </tr>
       <tr> <td align="left">     
       trait_code (Sex, Pigment stage..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitnum [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.trait_numeric</b> </td> </tr>
       <tr> <td align="left">     
       trait_code (Length_mm, Weight_g..)  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record];  
    traitmethod [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.traitmethod</b> </td> </tr>
       <tr> <td align="left">     
       Sex (Gonadal inspection), Sex (length based)..  <br align="left"/>
        </td> </tr> 
       </table>> 
       shape = record]; 
    traitqalvalue [fillcolor="gray"
       label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
       <tr> <td> <b>ref.traitqalvalue</b> </td> </tr>
       <tr> <td align="left">     
       traitqalcode (pigment stage, sex..)  <br align="left"/>
       qalValue (VB, M(male), F(female))
        </td> </tr> 
       </table>> 
       shape = record];               
   tseel [fillcolor="pink"
       label="dateel.series"
       shape = table];   
   mettseel [fillcolor="pink"
       label="dateel.metadata-series"
       shape = folder];
   anneel [fillcolor="pink"
       label="dat.annual-series"
       shape = record]; 
   grouptraiteel [fillcolor="pink"
       label="dateel.grouptrait"
       shape = record];  
   indtraiteel [fillcolor="pink"
       label="dateel.indtrait"
       shape = record]; 
   fisheel [fillcolor="pink"
       label="dateel.fish"
       shape = record];
   traiteel [fillcolor="pink"
       label="dateel.trait"
       shape = record];       
   tsnas [fillcolor="limegreen"
       label="datnas.series"
       shape = table];   
   indtraitnas [fillcolor="limegreen"
       label="datnas.indtrait"
       shape = record]; 
   fishnas [fillcolor="limegreen"
       label="datnas.fish"
       shape = record]; 
  traitnas [fillcolor="limegreen"
       label="datnas.trait"
       shape = record];  

  station_ts_join -> ts [label = "n:1"]
  station_ts_join -> stationDictionary  [label = "1:n"]
  ann ->  ts [label = "n:1"]
  grouptrait -> group->  ts [label = "n:1"]
  indtrait -> fish -> ts [label = "n:1"]
  indtrait -> trait [label = "n:1"]
  indtrait -> traitqalvalue [label = "n:1"]
  indtrait -> traitmethod [label = "n:1"]
  grouptrait -> trait [label = "n:1"]
  grouptrait -> traitqalvalue [label = "n:1"]
  grouptrait -> traitmethod [label = "n:1"]
  grouptrait -> anneel [label = "implicit (year - ser_id)", style="dashed"]
  trait -> traitnum [label="inherits", style="dashed"]
  trait -> traitqal [label="inherits", style="dashed"]
  traitqalvalue -> traitqal [label = "n:1"]
  grouptraiteel -> metanneel [label = "n:1"]
  anneel -> tseel [label = "n:1"]

  indtraiteel -> fisheel -> tseel  [label = "n:1"]
  


  indtraitnas -> fishnas -> tsnas  [label = "n:1"]

  grouptraiteel -> grouptrait [label="inherits", style="dashed"]
  indtraiteel -> indtrait [label="inherits", style="dashed"]
  indtraitnas -> indtrait [label="inherits", style="dashed"]
  fisheel -> fish [label="inherits", style="dashed"]
  fishnas -> fish [label="inherits", style="dashed"] 
  anneel -> ann [ label="inherits", style="dashed"]
  tseel -> ts [ label="inherits", style="dashed"]
  tsnas -> ts [ label="inherits", style="dashed", labelOverlay="15%"]
  mettseel -> metts [label="inherits", style="dashed"]
  traiteel -> trait [label="inherits", style="dashed"]
  traitnas -> trait [label="inherits", style="dashed"]
  group  // make the same rank

  {rank = same; tseel;tsnas}
}
```


