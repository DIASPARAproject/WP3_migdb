---
title: "From local to large scale: a habitat database alongside a dam and an electrofishing database to shift from continental habitats to population or panpopulation scales"
author: "Cédric Briand, Jules Oliviéro, Jani Helminen"
fontsize: 20pt
filters:
  - quarto-kroki
  - speakernotes
title-slide-attributes:
  data-background-image: images/diaspara_background.png
  data-background-size: stretch
  data-background-opacity: "0.5"
logo: images/diaspara_participants_logo_withEUlogo.png
footer: ""
format: 
  revealjs :
    self-contained: true
  pdf:
    speakernotes:
      displayNotes: true
      customStyle: |
        roundcorner=5pt,
        subtitlebelowline=true,
        subtitleaboveline=true,
        subtitlebackgroundcolor=yellow!70!white,
        backgroundcolor=blue!20!white,
        frametitle={Theorem},
        frametitlerule=true,
        frametitlebackgroundcolor=yellow!70!white,
theme: solarized
background-transition: fade
editor: visual
---

## This presentation

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-550275409.png "Eel and brown trout"){width="370"} ![](images/clipboard-639830824.png "electrofishing"){width="370"}
:::

::: {.column width="60%"}
[**Database development and:**]{style="font-size:45px"}

-   [**Regional and Global (Spatial) Models**]{style="font-size:40px"}

-   [**Migration obstacles and Electrofishing**]{style="font-size:40px"}

-   [**Biological and Biometric data**]{style="font-size:40px"}

-   [**Overall - Whole Stock**]{style="font-size:40px"}
:::
:::::

## This presentation

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-550275409.png "Eel and brown trout"){width="370"} ![](images/clipboard-639830824.png "electrofishing"){width="370"}
:::

::: {.column width="60%"}
-   [**Regional and Global (Spatial) Models**]{style="font-size:45px"}

A big reason why we needed habitat database
:::
:::::

# Taking different regions into account

**Remember from previous presentations:**

![](images/clipboard-1502028863.png)

# What amazing species! What a scientific challenge!

**Remember from previous presentations:**

-   Nested dynamics: pooled marine phase, independent continental phase
-   Local pressures can have consequences at larger scale
    -   Management is often local: consequences at larger scale
    -   Assessment of management actions
-   Large scale pressure can impact local dynamics (e.g. marine fisheries)

# The spatial / habitat model?

::::: columns
::: {.column .incremental width="50%"}

-   Regional aspects in WGBAST, WGNAS and WGBAST
-   WGTRUTTA https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p6/wgtrutta_database_description.html
:::

::: {.column width="50%"}
![](images/clipboard-1441936957.png)
:::
:::::

# Scale of each model? Not known

::::: columns
::: {.column .incremental width="50%"}
-   In the past, only marine habitat available -\> now marine and continental
-   With this approach we can test different structures and levels
-   Data to collected locally, used in (m)any needed scale
:::

::: {.column width="50%"}
![](images/clipboard-3523976769.png)
:::
:::::

# Habitat DB to move from local to higher scale

-   Data structured in regional level for SAM
-   Need upscaling: need upscaling methods
-   Identify similar areas, identify different areas

# What is the appropriate spatial scale? Not known yet? MERGE THIS ONE AND THREE OF THE SAME

-   All have the structure to group things at regional level

![](images/clipboard-3102186189.png)

# INTRODUCE THE NEED FOR REGIONAL MODELS
-   Examples from (Hilaire presentation) from EDA
-    How are we going to do it: DAm and EF

# JULES to ADD SLIDES HERE

# Introduction about how we want to develop spatial model in EDA
-   We need to do it, use EDA

## This presentation

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-550275409.png "Eel and brown trout"){width="370"} ![](images/clipboard-639830824.png "electrofishing"){width="370"}
:::

::: {.column width="60%"}
-   [**Migration Obstacles and electrofishing**]{style="font-size:45px"}
:::
:::::

# Different pressures, quantification issues?

-   Obstacles, turbines matched to habitat
-   E.g., WGTRUTTA work

# Example FROM CEDRIC

-   Rivers at the bottom, dams on top
-   Dam db structure

# Electrofishing linking to habitat data

-   Electrofishing similarly to migration obstacles
-   We are working on this db now
-   Templates to be tested


## Dam Database

```{r}
#| label: tbl-obstruction_place
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none

if(Sys.info()[["user"]] == 'joliviero'){
  setwd("D:/workspace/DIASPARA_WP3_migdb/R")
  datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
  setwd("C:/workspace/DIASPARA_WP3_migdb/R")
  datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Eaux&Vilaine/Projets/DIASPARA/wgbast"
}
source("utilities/load_library.R")
load_library("tidyverse")
load_library("RPostgres")
load_library("yaml")
load_library("DBI")
load_library("ggplot2")
load_library("sf")
load_library("janitor") #
load_library("htmltools") 
load_library("leaflet")
cred <- read_yaml("../credentials.yml")
con_diaspara <- dbConnect(Postgres(), 
                          dbname = cred$dbnamediaspara,
                          host = cred$hostdistant,
                          port = cred$port,
                          user = cred$userdiaspara,
                          password = cred$passworddiaspara)
dbGetQuery(con_diaspara, "SELECT 
op_placename,
op_op_id,
op_id_original,
op_country
 FROM dam_france.obstruction_place limit 500;") |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 7,        
    scrollX= TRUE   
  )
) |>
  htmltools::tagList(
   

    tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )

```

# DAM DATABASE

```{r}
#| label: fig-obstruction_place
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE

query <- "SELECT op_id_original,
                 op_placename, 
                 ob_height, 
                 ot.no_code as type,                 
                 geom 
          FROM dam_france.obstruction_place op
          JOIN dam_france.obstruction o
             ON ob_op_id = op_id
          JOIN nomenclature.obstruction_type ot
             ON ob_obstruction_type_no_id = ot.no_id
          JOIN refeel.tr_area_are are ON 
          st_intersects(st_transform(op.geom, 4326), are.geom_polygon)
          WHERE are_code = 'FR_Bret'
          AND ob_ending_date = '2035-01-01'
          "

layer <- st_read(dsn = con_diaspara, query = query) |> 
         sf::st_transform(4326) 

save(layer, file = "data/dammap_presentation.Rdata")
load(file = "data/dammap_presentation.Rdata")
layer <- layer |>
          mutate(label = sprintf(
            '%s <br>	
             code: %s <br>
             type: %s <br>				
					   h: %1.2f,<br> ',
            stringi::stri_trans_general(layer$op_placename, "latin-ascii"),
            layer$op_id_original,
            layer$type,            
            layer$ob_height
          )) 
layer$size <-  1+log(layer$ob_height+1) #  range 1-13
layer$size[is.na(layer$size)] <- 0.01
layer$type[is.na(layer$type)]<-"NA"

colorfun <- leaflet::colorFactor(RColorBrewer::brewer.pal(length(unique(layer$type)),name ="Set1"), as.factor(layer$type))

l <- leaflet::leaflet() |>
     leaflet::addScaleBar(options = leaflet::scaleBarOptions(imperial = FALSE)) |>
     leaflet::addProviderTiles(leaflet::providers$CartoDB.DarkMatter) |>
     leaflet::addCircleMarkers(
        data = layer[1:500,],
        popup = ~label,
        color = ~colorfun(as.factor(type)),       
        radius = ~size       
      ) |>
      leaflet::addLegend(
        position="topright",
        colors = c("blue","cyan","darkgreen","limegreen","red","orange", "grey","black"),
        labels = c("h=0, prod=NA", "h=0, prod !=NA", "Presence passe, prod=NA", "Presence passe, prod !=NA", "Pas de passe, prod=NA", "Pas de passe, prod!=NA", "h predite, prod NA", "h predite, prod!=NA"),
        opacity = 1)
    } 

               
                leaflet::addLegend("bottomleft",
                    pal = pal,
                    values = ~ pal(shp[[column]]),
                    title = "Hauteurs cumulées (en m)",
                    opacity = 1
                )        if (output == "leaflet") {
           

```


## This presentation

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-550275409.png "Eel and brown trout"){width="370"} ![](images/clipboard-639830824.png "electrofishing"){width="370"}
:::

::: {.column width="60%"}
-   [**Biological and Biometric data**]{style="font-size:45px"}

Everything is linked to Life History Trait data
:::
:::::

# New database - data available for use

-   This is an example why it was important to use ICES Vocabulary as much as possible

![](images/clipboard-2022634687.png)

# All groups have identified this need, but it was not easily accessible

::::: columns
::: {.column .incremental width="50%"}
-   Get the Biological data in a database
-   Use it for analysis
-   Understanding growth, fecundity, etc. **over time and spatially**
:::

::: {.column width="50%"}
![](images/clipboard-2516448368.png)
:::
:::::

# BEFORE INTRODUCING THE METRIC DB 
- relate to WGEEL recruitment trend analysis: analysis of silver eel or yellow eel.
- Maybe something from WGBAST

# Example of group metrics

-   EXAMPLE HERE

# Example of individual metrics

-   EXAMPLE HERE

# Other parameters

# Trend analysis - why do we need series?

-   Example from WGEEL (CEDRIC)
-   Example from WGNAS (CEDRIC)

## This presentation

::::: columns
::: {.column .incremental width="40%"}
![](images/clipboard-550275409.png "Eel and brown trout"){width="370"} ![](images/clipboard-639830824.png "electrofishing"){width="370"}
:::

::: {.column width="60%"}
-   [**Overall - Whole Stock**]{style="font-size:45px"}
:::
:::::



# Quality control

::::: Columns
::: {.column width="50%"}
-   Need of DB input and output in TAF
-   Data treatment
-   Tried to follow the existing WG formats as closely as possible, to not destroy current work!
:::

::: {.column width="50%"}
-   EXAMPLES
-   Show Hennis or NAS
-   What has been done in WGNAS
-   Shiny treatment of the output to detect changes
-   Pierre Yeves
:::
:::::

# EXAMPLES FROM CEDRIC HERE
-   WGBAST 2 databses are used
-   WGNAS work briefly

# Thank you!
